export class ImageTrimmer {
    constructor() { }
    async loadByDataUrl(dataUrl) {
        const image = await new Promise((resolve, reject) => {
            const image = new Image();
            image.src = dataUrl;
            image.onload = () => {
                resolve(image);
            };
        });
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.width = image.width;
        canvas.height = image.height;
        context.drawImage(image, 0, 0);
        this.canvas = canvas;
        this.context = context;
    }
    async trimMargin(marginColor, diffThreshold = 10) {
        if (this.canvas === undefined)
            throw new Error('Image is not loaded');
        // マージンを検出する範囲を指定 (左端から0〜20%)
        const edgeDetectionRangeMinX = 0;
        const edgeDetectionRangeMaxX = Math.floor(this.canvas.width * 0.2);
        // マージンの端を検出
        const edgePositionFromTop = await this.getVerticalEdgePositionOfColor(marginColor, 'top', diffThreshold, edgeDetectionRangeMinX, edgeDetectionRangeMaxX);
        const marginTop = edgePositionFromTop != null ? edgePositionFromTop : 0;
        const edgePositionFromBottom = await this.getVerticalEdgePositionOfColor(marginColor, 'bottom', diffThreshold, edgeDetectionRangeMinX, edgeDetectionRangeMaxX);
        const marginBottom = edgePositionFromBottom != null
            ? edgePositionFromBottom
            : this.canvas.height;
        const oldHeight = this.canvas.height;
        const newHeight = marginBottom - marginTop;
        this.crop(0, marginTop, this.canvas.width, newHeight);
        return {
            marginTop: marginTop,
            marginBottom: marginBottom,
            heightNew: newHeight,
            heightOld: oldHeight,
            width: this.canvas.width,
        };
    }
    async crop(x, y, w, h) {
        if (!this.canvas || !this.context)
            return;
        const newCanvas = document.createElement('canvas');
        const newContext = newCanvas.getContext('2d');
        newCanvas.width = w;
        newCanvas.height = h;
        newContext.drawImage(this.canvas, x, y, newCanvas.width, newCanvas.height, 0, 0, newCanvas.width, newCanvas.height);
        this.replaceCanvas(newCanvas);
    }
    async replaceColor(srcColor, dstColor, diffThreshold) {
        if (!this.canvas || !this.context)
            return;
        const imageData = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);
        const dstColorValue = this.hexColorCodeToRgba(dstColor);
        for (let x = 0; x < imageData.width; x++) {
            for (let y = 0; y < imageData.height; y++) {
                const idx = (x + y * imageData.width) * 4;
                const red = imageData.data[idx + 0];
                const green = imageData.data[idx + 1];
                const blue = imageData.data[idx + 2];
                const alpha = imageData.data[idx + 3];
                const colorCode = this.rgbToHexColorCode(red, green, blue);
                if (!this.isSimilarColor(srcColor, colorCode, diffThreshold)) {
                    continue;
                }
                imageData.data[idx + 0] = dstColorValue.r;
                imageData.data[idx + 1] = dstColorValue.g;
                imageData.data[idx + 2] = dstColorValue.b;
                if (dstColorValue.a !== undefined) {
                    imageData.data[idx + 3] = dstColorValue.a;
                }
            }
        }
        this.context.putImageData(imageData, 0, 0);
    }
    async getMarginColor() {
        if (!this.canvas || !this.context) {
            return null;
        }
        let marginColor = null;
        const imageData = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);
        let isBreak = false;
        for (let x = 0; x < imageData.width && !isBreak; x++) {
            for (let y = 0; y < imageData.height; y++) {
                const idx = (x + y * imageData.width) * 4;
                const red = imageData.data[idx + 0];
                const green = imageData.data[idx + 1];
                const blue = imageData.data[idx + 2];
                const alpha = imageData.data[idx + 3];
                const colorCode = this.rgbToHexColorCode(red, green, blue);
                if (marginColor != colorCode) {
                    if (marginColor === null) {
                        marginColor = colorCode;
                    }
                    else {
                        isBreak = true;
                        break;
                    }
                }
            }
        }
        return marginColor;
    }
    async getVerticalEdgePositionOfColor(color, direction, diffThreshold, minX, maxX) {
        if (!this.canvas || !this.context) {
            return null;
        }
        if (minX === undefined) {
            minX = 0;
        }
        if (maxX === undefined) {
            maxX = this.canvas.width;
        }
        const imageData = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);
        let isBreak = false;
        let edgePositionY;
        if (direction === 'top') {
            edgePositionY = 0;
            for (let y = 0; y < imageData.height; y++) {
                for (let x = 0; x < maxX && !isBreak; x++) {
                    const idx = (x + y * imageData.width) * 4;
                    const red = imageData.data[idx + 0];
                    const green = imageData.data[idx + 1];
                    const blue = imageData.data[idx + 2];
                    const alpha = imageData.data[idx + 3];
                    const colorCode = this.rgbToHexColorCode(red, green, blue);
                    if (color == colorCode ||
                        this.isSimilarColor(color, colorCode, diffThreshold)) {
                        if (edgePositionY < y) {
                            edgePositionY = y;
                        }
                    }
                    else {
                        isBreak = true;
                        break;
                    }
                }
            }
            if (edgePositionY !== 0) {
                edgePositionY += 1;
            }
        }
        else if (direction === 'bottom') {
            edgePositionY = this.canvas.height;
            for (let y = imageData.height - 1; y >= 0; y--) {
                for (let x = 0; x < imageData.width && !isBreak; x++) {
                    const idx = (x + y * imageData.width) * 4;
                    const red = imageData.data[idx + 0];
                    const green = imageData.data[idx + 1];
                    const blue = imageData.data[idx + 2];
                    const alpha = imageData.data[idx + 3];
                    const colorCode = this.rgbToHexColorCode(red, green, blue);
                    if (color == colorCode ||
                        this.isSimilarColor(color, colorCode, diffThreshold)) {
                        if (edgePositionY > y) {
                            edgePositionY = y;
                        }
                    }
                    else {
                        isBreak = true;
                        break;
                    }
                }
            }
            if (edgePositionY !== this.canvas.height) {
                edgePositionY -= 1;
            }
        }
        return edgePositionY;
    }
    async getWidth() {
        return this.canvas?.width;
    }
    async getHeight() {
        return this.canvas?.height;
    }
    async resizeWithFit(param) {
        if (!this.canvas) {
            return;
        }
        let newWidth = 0, newHeight = 0;
        if (param.width && this.canvas.width > param.width) {
            newWidth = param.width ? param.width : this.canvas.width;
            newHeight = this.canvas.height * (newWidth / this.canvas.width);
        }
        else if (param.height && this.canvas.height > param.height) {
            newHeight = param.height ? param.height : this.canvas.height;
            newWidth = this.canvas.width * (newHeight / this.canvas.height);
        }
        else {
            return;
        }
        const newCanvas = document.createElement('canvas');
        const newContext = newCanvas.getContext('2d');
        newCanvas.width = newWidth;
        newCanvas.height = newHeight;
        newContext.drawImage(this.canvas, 0, 0, newWidth, newHeight);
        this.replaceCanvas(newCanvas);
    }
    replaceCanvas(canvas) {
        if (!this.canvas || !this.context) {
            this.canvas = canvas;
            this.context = this.canvas.getContext('2d');
            return;
        }
        this.canvas.width = 0;
        this.canvas.height = 0;
        delete this.canvas;
        delete this.context;
        this.canvas = canvas;
        this.context = this.canvas.getContext('2d');
    }
    async getDataUrl(mime = 'image/jpeg', imageQuality) {
        if (!this.canvas) {
            return null;
        }
        if (mime === 'image/jpeg' || mime === 'image/webp') {
            return this.canvas.toDataURL(mime, imageQuality);
        }
        else {
            return this.canvas.toDataURL(mime);
        }
    }
    hexColorCodeToRgba(color) {
        const r = parseInt(color.substr(1, 2), 16);
        const g = parseInt(color.substr(3, 2), 16);
        const b = parseInt(color.substr(5, 2), 16);
        if (color.length === 9) {
            const a = parseInt(color.substr(7, 2), 16);
            return { r, g, b, a };
        }
        return { r, g, b };
    }
    rgbToHexColorCode(r, g, b) {
        return '#' + this.valueToHex(r) + this.valueToHex(g) + this.valueToHex(b);
    }
    valueToHex(value) {
        return ('0' + value.toString(16)).slice(-2);
    }
    isSimilarColor(color1, color2, diffThreshold) {
        const color1Rgb = this.hexColorCodeToRgba(color1);
        const color2Rgb = this.hexColorCodeToRgba(color2);
        const diff = Math.abs(color1Rgb.r - color2Rgb.r) +
            Math.abs(color1Rgb.g - color2Rgb.g) +
            Math.abs(color1Rgb.b - color2Rgb.b);
        return diff < diffThreshold;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1hZ2UtdHJpbW1lci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1tcC1wb3NlLWV4dHJhY3Rvci9zcmMvbGliL2NsYXNzZXMvaW50ZXJuYWxzL2ltYWdlLXRyaW1tZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsTUFBTSxPQUFPLFlBQVk7SUFJdkIsZ0JBQWUsQ0FBQztJQUVoQixLQUFLLENBQUMsYUFBYSxDQUFDLE9BQWU7UUFDakMsTUFBTSxLQUFLLEdBQXFCLE1BQU0sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDcEUsTUFBTSxLQUFLLEdBQUcsSUFBSSxLQUFLLEVBQUUsQ0FBQztZQUMxQixLQUFLLENBQUMsR0FBRyxHQUFHLE9BQU8sQ0FBQztZQUNwQixLQUFLLENBQUMsTUFBTSxHQUFHLEdBQUcsRUFBRTtnQkFDbEIsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2pCLENBQUMsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNoRCxNQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBRSxDQUFDO1FBQ3pDLE1BQU0sQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQztRQUMzQixNQUFNLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUM7UUFDN0IsT0FBTyxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBRS9CLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO0lBQ3pCLENBQUM7SUFFRCxLQUFLLENBQUMsVUFBVSxDQUFDLFdBQW1CLEVBQUUsZ0JBQXdCLEVBQUU7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TyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUM7SUFDckIsQ0FBQztJQUVPLGlCQUFpQixDQUFDLENBQVMsRUFBRSxDQUFTLEVBQUUsQ0FBUztRQUN2RCxPQUFPLEdBQUcsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUM1RSxDQUFDO0lBRU8sVUFBVSxDQUFDLEtBQWE7UUFDOUIsT0FBTyxDQUFDLEdBQUcsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDOUMsQ0FBQztJQUVPLGNBQWMsQ0FDcEIsTUFBYyxFQUNkLE1BQWMsRUFDZCxhQUFxQjtRQUVyQixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDbEQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ2xELE1BQU0sSUFBSSxHQUNSLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ25DLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ25DLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdEMsT0FBTyxJQUFJLEdBQUcsYUFBYSxDQUFDO0lBQzlCLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGxzdGF0IH0gZnJvbSAnZnMnO1xuXG5leHBvcnQgY2xhc3MgSW1hZ2VUcmltbWVyIHtcbiAgcHJpdmF0ZSBjYW52YXM/OiBIVE1MQ2FudmFzRWxlbWVudDtcbiAgcHJpdmF0ZSBjb250ZXh0PzogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJEO1xuXG4gIGNvbnN0cnVjdG9yKCkge31cblxuICBhc3luYyBsb2FkQnlEYXRhVXJsKGRhdGFVcmw6IHN0cmluZykge1xuICAgIGNvbnN0IGltYWdlOiBIVE1MSW1hZ2VFbGVtZW50ID0gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgaW1hZ2UgPSBuZXcgSW1hZ2UoKTtcbiAgICAgIGltYWdlLnNyYyA9IGRhdGFVcmw7XG4gICAgICBpbWFnZS5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgIHJlc29sdmUoaW1hZ2UpO1xuICAgICAgfTtcbiAgICB9KTtcblxuICAgIGNvbnN0IGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xuICAgIGNvbnN0IGNvbnRleHQgPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKSE7XG4gICAgY2FudmFzLndpZHRoID0gaW1hZ2Uud2lkdGg7XG4gICAgY2FudmFzLmhlaWdodCA9IGltYWdlLmhlaWdodDtcbiAgICBjb250ZXh0LmRyYXdJbWFnZShpbWFnZSwgMCwgMCk7XG5cbiAgICB0aGlzLmNhbnZhcyA9IGNhbnZhcztcbiAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0O1xuICB9XG5cbiAgYXN5bmMgdHJpbU1hcmdpbihtYXJnaW5Db2xvcjogc3RyaW5nLCBkaWZmVGhyZXNob2xkOiBudW1iZXIgPSAxMCkge1xuICAgIGlmICh0aGlzLmNhbnZhcyA9PT0gdW5kZWZpbmVkKSB0aHJvdyBuZXcgRXJyb3IoJ0ltYWdlIGlzIG5vdCBsb2FkZWQnKTtcblxuICAgIC8vIOODnuODvOOCuOODs+OCkuaknOWHuuOBmeOCi+evhOWbsuOCkuaMh+WumiAo5bem56uv44GL44KJMOOAnDIwJSlcbiAgICBjb25zdCBlZGdlRGV0ZWN0aW9uUmFuZ2VNaW5YID0gMDtcbiAgICBjb25zdCBlZGdlRGV0ZWN0aW9uUmFuZ2VNYXhYID0gTWF0aC5mbG9vcih0aGlzLmNhbnZhcy53aWR0aCAqIDAuMik7XG5cbiAgICAvLyDjg57jg7zjgrjjg7Pjga7nq6/jgpLmpJzlh7pcbiAgICBjb25zdCBlZGdlUG9zaXRpb25Gcm9tVG9wID0gYXdhaXQgdGhpcy5nZXRWZXJ0aWNhbEVkZ2VQb3NpdGlvbk9mQ29sb3IoXG4gICAgICBtYXJnaW5Db2xvcixcbiAgICAgICd0b3AnLFxuICAgICAgZGlmZlRocmVzaG9sZCxcbiAgICAgIGVkZ2VEZXRlY3Rpb25SYW5nZU1pblgsXG4gICAgICBlZGdlRGV0ZWN0aW9uUmFuZ2VNYXhYXG4gICAgKTtcbiAgICBjb25zdCBtYXJnaW5Ub3AgPSBlZGdlUG9zaXRpb25Gcm9tVG9wICE9IG51bGwgPyBlZGdlUG9zaXRpb25Gcm9tVG9wIDogMDtcblxuICAgIGNvbnN0IGVkZ2VQb3NpdGlvbkZyb21Cb3R0b20gPSBhd2FpdCB0aGlzLmdldFZlcnRpY2FsRWRnZVBvc2l0aW9uT2ZDb2xvcihcbiAgICAgIG1hcmdpbkNvbG9yLFxuICAgICAgJ2JvdHRvbScsXG4gICAgICBkaWZmVGhyZXNob2xkLFxuICAgICAgZWRnZURldGVjdGlvblJhbmdlTWluWCxcbiAgICAgIGVkZ2VEZXRlY3Rpb25SYW5nZU1heFhcbiAgICApO1xuICAgIGNvbnN0IG1hcmdpbkJvdHRvbSA9XG4gICAgICBlZGdlUG9zaXRpb25Gcm9tQm90dG9tICE9IG51bGxcbiAgICAgICAgPyBlZGdlUG9zaXRpb25Gcm9tQm90dG9tXG4gICAgICAgIDogdGhpcy5jYW52YXMuaGVpZ2h0O1xuXG4gICAgY29uc3Qgb2xkSGVpZ2h0ID0gdGhpcy5jYW52YXMuaGVpZ2h0O1xuICAgIGNvbnN0IG5ld0hlaWdodCA9IG1hcmdpbkJvdHRvbSAtIG1hcmdpblRvcDtcbiAgICB0aGlzLmNyb3AoMCwgbWFyZ2luVG9wLCB0aGlzLmNhbnZhcy53aWR0aCwgbmV3SGVpZ2h0KTtcblxuICAgIHJldHVybiB7XG4gICAgICBtYXJnaW5Ub3A6IG1hcmdpblRvcCxcbiAgICAgIG1hcmdpbkJvdHRvbTogbWFyZ2luQm90dG9tLFxuICAgICAgaGVpZ2h0TmV3OiBuZXdIZWlnaHQsXG4gICAgICBoZWlnaHRPbGQ6IG9sZEhlaWdodCxcbiAgICAgIHdpZHRoOiB0aGlzLmNhbnZhcy53aWR0aCxcbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgY3JvcCh4OiBudW1iZXIsIHk6IG51bWJlciwgdzogbnVtYmVyLCBoOiBudW1iZXIpIHtcbiAgICBpZiAoIXRoaXMuY2FudmFzIHx8ICF0aGlzLmNvbnRleHQpIHJldHVybjtcblxuICAgIGNvbnN0IG5ld0NhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xuICAgIGNvbnN0IG5ld0NvbnRleHQgPSBuZXdDYW52YXMuZ2V0Q29udGV4dCgnMmQnKSE7XG4gICAgbmV3Q2FudmFzLndpZHRoID0gdztcbiAgICBuZXdDYW52YXMuaGVpZ2h0ID0gaDtcbiAgICBuZXdDb250ZXh0LmRyYXdJbWFnZShcbiAgICAgIHRoaXMuY2FudmFzLFxuICAgICAgeCxcbiAgICAgIHksXG4gICAgICBuZXdDYW52YXMud2lkdGgsXG4gICAgICBuZXdDYW52YXMuaGVpZ2h0LFxuICAgICAgMCxcbiAgICAgIDAsXG4gICAgICBuZXdDYW52YXMud2lkdGgsXG4gICAgICBuZXdDYW52YXMuaGVpZ2h0XG4gICAgKTtcbiAgICB0aGlzLnJlcGxhY2VDYW52YXMobmV3Q2FudmFzKTtcbiAgfVxuXG4gIGFzeW5jIHJlcGxhY2VDb2xvcihcbiAgICBzcmNDb2xvcjogc3RyaW5nLFxuICAgIGRzdENvbG9yOiBzdHJpbmcsXG4gICAgZGlmZlRocmVzaG9sZDogbnVtYmVyXG4gICkge1xuICAgIGlmICghdGhpcy5jYW52YXMgfHwgIXRoaXMuY29udGV4dCkgcmV0dXJuO1xuXG4gICAgY29uc3QgaW1hZ2VEYXRhID0gdGhpcy5jb250ZXh0LmdldEltYWdlRGF0YShcbiAgICAgIDAsXG4gICAgICAwLFxuICAgICAgdGhpcy5jYW52YXMud2lkdGgsXG4gICAgICB0aGlzLmNhbnZhcy5oZWlnaHRcbiAgICApO1xuXG4gICAgY29uc3QgZHN0Q29sb3JWYWx1ZSA9IHRoaXMuaGV4Q29sb3JDb2RlVG9SZ2JhKGRzdENvbG9yKTtcblxuICAgIGZvciAobGV0IHggPSAwOyB4IDwgaW1hZ2VEYXRhLndpZHRoOyB4KyspIHtcbiAgICAgIGZvciAobGV0IHkgPSAwOyB5IDwgaW1hZ2VEYXRhLmhlaWdodDsgeSsrKSB7XG4gICAgICAgIGNvbnN0IGlkeCA9ICh4ICsgeSAqIGltYWdlRGF0YS53aWR0aCkgKiA0O1xuICAgICAgICBjb25zdCByZWQgPSBpbWFnZURhdGEuZGF0YVtpZHggKyAwXTtcbiAgICAgICAgY29uc3QgZ3JlZW4gPSBpbWFnZURhdGEuZGF0YVtpZHggKyAxXTtcbiAgICAgICAgY29uc3QgYmx1ZSA9IGltYWdlRGF0YS5kYXRhW2lkeCArIDJdO1xuICAgICAgICBjb25zdCBhbHBoYSA9IGltYWdlRGF0YS5kYXRhW2lkeCArIDNdO1xuXG4gICAgICAgIGNvbnN0IGNvbG9yQ29kZSA9IHRoaXMucmdiVG9IZXhDb2xvckNvZGUocmVkLCBncmVlbiwgYmx1ZSk7XG4gICAgICAgIGlmICghdGhpcy5pc1NpbWlsYXJDb2xvcihzcmNDb2xvciwgY29sb3JDb2RlLCBkaWZmVGhyZXNob2xkKSkge1xuICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgaW1hZ2VEYXRhLmRhdGFbaWR4ICsgMF0gPSBkc3RDb2xvclZhbHVlLnI7XG4gICAgICAgIGltYWdlRGF0YS5kYXRhW2lkeCArIDFdID0gZHN0Q29sb3JWYWx1ZS5nO1xuICAgICAgICBpbWFnZURhdGEuZGF0YVtpZHggKyAyXSA9IGRzdENvbG9yVmFsdWUuYjtcbiAgICAgICAgaWYgKGRzdENvbG9yVmFsdWUuYSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgaW1hZ2VEYXRhLmRhdGFbaWR4ICsgM10gPSBkc3RDb2xvclZhbHVlLmE7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLmNvbnRleHQucHV0SW1hZ2VEYXRhKGltYWdlRGF0YSwgMCwgMCk7XG4gIH1cblxuICBhc3luYyBnZXRNYXJnaW5Db2xvcigpIHtcbiAgICBpZiAoIXRoaXMuY2FudmFzIHx8ICF0aGlzLmNvbnRleHQpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBsZXQgbWFyZ2luQ29sb3I6IHN0cmluZyB8IG51bGwgPSBudWxsO1xuXG4gICAgY29uc3QgaW1hZ2VEYXRhID0gdGhpcy5jb250ZXh0LmdldEltYWdlRGF0YShcbiAgICAgIDAsXG4gICAgICAwLFxuICAgICAgdGhpcy5jYW52YXMud2lkdGgsXG4gICAgICB0aGlzLmNhbnZhcy5oZWlnaHRcbiAgICApO1xuXG4gICAgbGV0IGlzQnJlYWsgPSBmYWxzZTtcbiAgICBmb3IgKGxldCB4ID0gMDsgeCA8IGltYWdlRGF0YS53aWR0aCAmJiAhaXNCcmVhazsgeCsrKSB7XG4gICAgICBmb3IgKGxldCB5ID0gMDsgeSA8IGltYWdlRGF0YS5oZWlnaHQ7IHkrKykge1xuICAgICAgICBjb25zdCBpZHggPSAoeCArIHkgKiBpbWFnZURhdGEud2lkdGgpICogNDtcbiAgICAgICAgY29uc3QgcmVkID0gaW1hZ2VEYXRhLmRhdGFbaWR4ICsgMF07XG4gICAgICAgIGNvbnN0IGdyZWVuID0gaW1hZ2VEYXRhLmRhdGFbaWR4ICsgMV07XG4gICAgICAgIGNvbnN0IGJsdWUgPSBpbWFnZURhdGEuZGF0YVtpZHggKyAyXTtcbiAgICAgICAgY29uc3QgYWxwaGEgPSBpbWFnZURhdGEuZGF0YVtpZHggKyAzXTtcblxuICAgICAgICBjb25zdCBjb2xvckNvZGUgPSB0aGlzLnJnYlRvSGV4Q29sb3JDb2RlKHJlZCwgZ3JlZW4sIGJsdWUpO1xuICAgICAgICBpZiAobWFyZ2luQ29sb3IgIT0gY29sb3JDb2RlKSB7XG4gICAgICAgICAgaWYgKG1hcmdpbkNvbG9yID09PSBudWxsKSB7XG4gICAgICAgICAgICBtYXJnaW5Db2xvciA9IGNvbG9yQ29kZTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaXNCcmVhayA9IHRydWU7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbWFyZ2luQ29sb3I7XG4gIH1cblxuICBhc3luYyBnZXRWZXJ0aWNhbEVkZ2VQb3NpdGlvbk9mQ29sb3IoXG4gICAgY29sb3I6IHN0cmluZyxcbiAgICBkaXJlY3Rpb246ICd0b3AnIHwgJ2JvdHRvbScsXG4gICAgZGlmZlRocmVzaG9sZDogbnVtYmVyLFxuICAgIG1pblg/OiBudW1iZXIsXG4gICAgbWF4WD86IG51bWJlclxuICApIHtcbiAgICBpZiAoIXRoaXMuY2FudmFzIHx8ICF0aGlzLmNvbnRleHQpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGlmIChtaW5YID09PSB1bmRlZmluZWQpIHtcbiAgICAgIG1pblggPSAwO1xuICAgIH1cbiAgICBpZiAobWF4WCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBtYXhYID0gdGhpcy5jYW52YXMud2lkdGg7XG4gICAgfVxuXG4gICAgY29uc3QgaW1hZ2VEYXRhID0gdGhpcy5jb250ZXh0LmdldEltYWdlRGF0YShcbiAgICAgIDAsXG4gICAgICAwLFxuICAgICAgdGhpcy5jYW52YXMud2lkdGgsXG4gICAgICB0aGlzLmNhbnZhcy5oZWlnaHRcbiAgICApO1xuXG4gICAgbGV0IGlzQnJlYWsgPSBmYWxzZTtcblxuICAgIGxldCBlZGdlUG9zaXRpb25ZO1xuICAgIGlmIChkaXJlY3Rpb24gPT09ICd0b3AnKSB7XG4gICAgICBlZGdlUG9zaXRpb25ZID0gMDtcblxuICAgICAgZm9yIChsZXQgeSA9IDA7IHkgPCBpbWFnZURhdGEuaGVpZ2h0OyB5KyspIHtcbiAgICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCBtYXhYICYmICFpc0JyZWFrOyB4KyspIHtcbiAgICAgICAgICBjb25zdCBpZHggPSAoeCArIHkgKiBpbWFnZURhdGEud2lkdGgpICogNDtcbiAgICAgICAgICBjb25zdCByZWQgPSBpbWFnZURhdGEuZGF0YVtpZHggKyAwXTtcbiAgICAgICAgICBjb25zdCBncmVlbiA9IGltYWdlRGF0YS5kYXRhW2lkeCArIDFdO1xuICAgICAgICAgIGNvbnN0IGJsdWUgPSBpbWFnZURhdGEuZGF0YVtpZHggKyAyXTtcbiAgICAgICAgICBjb25zdCBhbHBoYSA9IGltYWdlRGF0YS5kYXRhW2lkeCArIDNdO1xuXG4gICAgICAgICAgY29uc3QgY29sb3JDb2RlID0gdGhpcy5yZ2JUb0hleENvbG9yQ29kZShyZWQsIGdyZWVuLCBibHVlKTtcbiAgICAgICAgICBpZiAoXG4gICAgICAgICAgICBjb2xvciA9PSBjb2xvckNvZGUgfHxcbiAgICAgICAgICAgIHRoaXMuaXNTaW1pbGFyQ29sb3IoY29sb3IsIGNvbG9yQ29kZSwgZGlmZlRocmVzaG9sZClcbiAgICAgICAgICApIHtcbiAgICAgICAgICAgIGlmIChlZGdlUG9zaXRpb25ZIDwgeSkge1xuICAgICAgICAgICAgICBlZGdlUG9zaXRpb25ZID0geTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaXNCcmVhayA9IHRydWU7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKGVkZ2VQb3NpdGlvblkgIT09IDApIHtcbiAgICAgICAgZWRnZVBvc2l0aW9uWSArPSAxO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoZGlyZWN0aW9uID09PSAnYm90dG9tJykge1xuICAgICAgZWRnZVBvc2l0aW9uWSA9IHRoaXMuY2FudmFzLmhlaWdodDtcblxuICAgICAgZm9yIChsZXQgeSA9IGltYWdlRGF0YS5oZWlnaHQgLSAxOyB5ID49IDA7IHktLSkge1xuICAgICAgICBmb3IgKGxldCB4ID0gMDsgeCA8IGltYWdlRGF0YS53aWR0aCAmJiAhaXNCcmVhazsgeCsrKSB7XG4gICAgICAgICAgY29uc3QgaWR4ID0gKHggKyB5ICogaW1hZ2VEYXRhLndpZHRoKSAqIDQ7XG4gICAgICAgICAgY29uc3QgcmVkID0gaW1hZ2VEYXRhLmRhdGFbaWR4ICsgMF07XG4gICAgICAgICAgY29uc3QgZ3JlZW4gPSBpbWFnZURhdGEuZGF0YVtpZHggKyAxXTtcbiAgICAgICAgICBjb25zdCBibHVlID0gaW1hZ2VEYXRhLmRhdGFbaWR4ICsgMl07XG4gICAgICAgICAgY29uc3QgYWxwaGEgPSBpbWFnZURhdGEuZGF0YVtpZHggKyAzXTtcblxuICAgICAgICAgIGNvbnN0IGNvbG9yQ29kZSA9IHRoaXMucmdiVG9IZXhDb2xvckNvZGUocmVkLCBncmVlbiwgYmx1ZSk7XG4gICAgICAgICAgaWYgKFxuICAgICAgICAgICAgY29sb3IgPT0gY29sb3JDb2RlIHx8XG4gICAgICAgICAgICB0aGlzLmlzU2ltaWxhckNvbG9yKGNvbG9yLCBjb2xvckNvZGUsIGRpZmZUaHJlc2hvbGQpXG4gICAgICAgICAgKSB7XG4gICAgICAgICAgICBpZiAoZWRnZVBvc2l0aW9uWSA+IHkpIHtcbiAgICAgICAgICAgICAgZWRnZVBvc2l0aW9uWSA9IHk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlzQnJlYWsgPSB0cnVlO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmIChlZGdlUG9zaXRpb25ZICE9PSB0aGlzLmNhbnZhcy5oZWlnaHQpIHtcbiAgICAgICAgZWRnZVBvc2l0aW9uWSAtPSAxO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBlZGdlUG9zaXRpb25ZO1xuICB9XG5cbiAgYXN5bmMgZ2V0V2lkdGgoKSB7XG4gICAgcmV0dXJuIHRoaXMuY2FudmFzPy53aWR0aDtcbiAgfVxuXG4gIGFzeW5jIGdldEhlaWdodCgpIHtcbiAgICByZXR1cm4gdGhpcy5jYW52YXM/LmhlaWdodDtcbiAgfVxuXG4gIGFzeW5jIHJlc2l6ZVdpdGhGaXQocGFyYW06IHsgd2lkdGg/OiBudW1iZXI7IGhlaWdodD86IG51bWJlciB9KSB7XG4gICAgaWYgKCF0aGlzLmNhbnZhcykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxldCBuZXdXaWR0aDogbnVtYmVyID0gMCxcbiAgICAgIG5ld0hlaWdodDogbnVtYmVyID0gMDtcbiAgICBpZiAocGFyYW0ud2lkdGggJiYgdGhpcy5jYW52YXMud2lkdGggPiBwYXJhbS53aWR0aCkge1xuICAgICAgbmV3V2lkdGggPSBwYXJhbS53aWR0aCA/IHBhcmFtLndpZHRoIDogdGhpcy5jYW52YXMud2lkdGg7XG4gICAgICBuZXdIZWlnaHQgPSB0aGlzLmNhbnZhcy5oZWlnaHQgKiAobmV3V2lkdGggLyB0aGlzLmNhbnZhcy53aWR0aCk7XG4gICAgfSBlbHNlIGlmIChwYXJhbS5oZWlnaHQgJiYgdGhpcy5jYW52YXMuaGVpZ2h0ID4gcGFyYW0uaGVpZ2h0KSB7XG4gICAgICBuZXdIZWlnaHQgPSBwYXJhbS5oZWlnaHQgPyBwYXJhbS5oZWlnaHQgOiB0aGlzLmNhbnZhcy5oZWlnaHQ7XG4gICAgICBuZXdXaWR0aCA9IHRoaXMuY2FudmFzLndpZHRoICogKG5ld0hlaWdodCAvIHRoaXMuY2FudmFzLmhlaWdodCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBuZXdDYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcbiAgICBjb25zdCBuZXdDb250ZXh0ID0gbmV3Q2FudmFzLmdldENvbnRleHQoJzJkJykhO1xuICAgIG5ld0NhbnZhcy53aWR0aCA9IG5ld1dpZHRoO1xuICAgIG5ld0NhbnZhcy5oZWlnaHQgPSBuZXdIZWlnaHQ7XG4gICAgbmV3Q29udGV4dC5kcmF3SW1hZ2UodGhpcy5jYW52YXMsIDAsIDAsIG5ld1dpZHRoLCBuZXdIZWlnaHQpO1xuICAgIHRoaXMucmVwbGFjZUNhbnZhcyhuZXdDYW52YXMpO1xuICB9XG5cbiAgcHJpdmF0ZSByZXBsYWNlQ2FudmFzKGNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQpIHtcbiAgICBpZiAoIXRoaXMuY2FudmFzIHx8ICF0aGlzLmNvbnRleHQpIHtcbiAgICAgIHRoaXMuY2FudmFzID0gY2FudmFzO1xuICAgICAgdGhpcy5jb250ZXh0ID0gdGhpcy5jYW52YXMuZ2V0Q29udGV4dCgnMmQnKSE7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5jYW52YXMud2lkdGggPSAwO1xuICAgIHRoaXMuY2FudmFzLmhlaWdodCA9IDA7XG4gICAgZGVsZXRlIHRoaXMuY2FudmFzO1xuICAgIGRlbGV0ZSB0aGlzLmNvbnRleHQ7XG5cbiAgICB0aGlzLmNhbnZhcyA9IGNhbnZhcztcbiAgICB0aGlzLmNvbnRleHQgPSB0aGlzLmNhbnZhcy5nZXRDb250ZXh0KCcyZCcpITtcbiAgfVxuXG4gIGFzeW5jIGdldERhdGFVcmwoXG4gICAgbWltZTogJ2ltYWdlL2pwZWcnIHwgJ2ltYWdlL3BuZycgfCAnaW1hZ2Uvd2VicCcgPSAnaW1hZ2UvanBlZycsXG4gICAgaW1hZ2VRdWFsaXR5PzogbnVtYmVyXG4gICkge1xuICAgIGlmICghdGhpcy5jYW52YXMpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGlmIChtaW1lID09PSAnaW1hZ2UvanBlZycgfHwgbWltZSA9PT0gJ2ltYWdlL3dlYnAnKSB7XG4gICAgICByZXR1cm4gdGhpcy5jYW52YXMudG9EYXRhVVJMKG1pbWUsIGltYWdlUXVhbGl0eSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLmNhbnZhcy50b0RhdGFVUkwobWltZSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBoZXhDb2xvckNvZGVUb1JnYmEoY29sb3I6IHN0cmluZyk6IHtcbiAgICByOiBudW1iZXI7XG4gICAgZzogbnVtYmVyO1xuICAgIGI6IG51bWJlcjtcbiAgICBhPzogbnVtYmVyO1xuICB9IHtcbiAgICBjb25zdCByID0gcGFyc2VJbnQoY29sb3Iuc3Vic3RyKDEsIDIpLCAxNik7XG4gICAgY29uc3QgZyA9IHBhcnNlSW50KGNvbG9yLnN1YnN0cigzLCAyKSwgMTYpO1xuICAgIGNvbnN0IGIgPSBwYXJzZUludChjb2xvci5zdWJzdHIoNSwgMiksIDE2KTtcbiAgICBpZiAoY29sb3IubGVuZ3RoID09PSA5KSB7XG4gICAgICBjb25zdCBhID0gcGFyc2VJbnQoY29sb3Iuc3Vic3RyKDcsIDIpLCAxNik7XG4gICAgICByZXR1cm4geyByLCBnLCBiLCBhIH07XG4gICAgfVxuICAgIHJldHVybiB7IHIsIGcsIGIgfTtcbiAgfVxuXG4gIHByaXZhdGUgcmdiVG9IZXhDb2xvckNvZGUocjogbnVtYmVyLCBnOiBudW1iZXIsIGI6IG51bWJlcikge1xuICAgIHJldHVybiAnIycgKyB0aGlzLnZhbHVlVG9IZXgocikgKyB0aGlzLnZhbHVlVG9IZXgoZykgKyB0aGlzLnZhbHVlVG9IZXgoYik7XG4gIH1cblxuICBwcml2YXRlIHZhbHVlVG9IZXgodmFsdWU6IG51bWJlcikge1xuICAgIHJldHVybiAoJzAnICsgdmFsdWUudG9TdHJpbmcoMTYpKS5zbGljZSgtMik7XG4gIH1cblxuICBwcml2YXRlIGlzU2ltaWxhckNvbG9yKFxuICAgIGNvbG9yMTogc3RyaW5nLFxuICAgIGNvbG9yMjogc3RyaW5nLFxuICAgIGRpZmZUaHJlc2hvbGQ6IG51bWJlclxuICApIHtcbiAgICBjb25zdCBjb2xvcjFSZ2IgPSB0aGlzLmhleENvbG9yQ29kZVRvUmdiYShjb2xvcjEpO1xuICAgIGNvbnN0IGNvbG9yMlJnYiA9IHRoaXMuaGV4Q29sb3JDb2RlVG9SZ2JhKGNvbG9yMik7XG4gICAgY29uc3QgZGlmZiA9XG4gICAgICBNYXRoLmFicyhjb2xvcjFSZ2IuciAtIGNvbG9yMlJnYi5yKSArXG4gICAgICBNYXRoLmFicyhjb2xvcjFSZ2IuZyAtIGNvbG9yMlJnYi5nKSArXG4gICAgICBNYXRoLmFicyhjb2xvcjFSZ2IuYiAtIGNvbG9yMlJnYi5iKTtcbiAgICByZXR1cm4gZGlmZiA8IGRpZmZUaHJlc2hvbGQ7XG4gIH1cbn1cbiJdfQ==