import { EventEmitter, Injectable } from '@angular/core';
import { HAND_CONNECTIONS, Holistic, POSE_CONNECTIONS, POSE_LANDMARKS, POSE_LANDMARKS_LEFT, POSE_LANDMARKS_RIGHT, } from '@mediapipe/holistic';
import { drawConnectors, drawLandmarks, lerp } from '@mediapipe/drawing_utils';
import * as i0 from "@angular/core";
/**
 * MediaPipe を用いて動画からポーズを抽出するためのサービス
 *
 * ※ シングルトンなサービスではないため、Component で providers に指定して使用することを想定
 */
export class PoseExtractorService {
    constructor() {
        this.onResultsEventEmitter = new EventEmitter();
        this.init();
    }
    getPosePreviewMediaStream() {
        if (!this.posePreviewCanvasElement)
            return;
        return this.posePreviewCanvasElement.captureStream();
    }
    getHandPreviewMediaStream() {
        if (!this.handPreviewCanvasElement)
            return;
        return this.handPreviewCanvasElement.captureStream();
    }
    async onVideoFrame(videoElement) {
        if (!this.holistic)
            return;
        if (this.posePreviewCanvasElement) {
            this.posePreviewCanvasElement.width = videoElement.videoWidth;
            this.posePreviewCanvasElement.height = videoElement.videoHeight;
        }
        if (this.handPreviewCanvasElement) {
            this.handPreviewCanvasElement.width = videoElement.videoWidth;
            this.handPreviewCanvasElement.height = videoElement.videoHeight;
        }
        await this.holistic.send({ image: videoElement });
    }
    init() {
        this.posePreviewCanvasElement = document.createElement('canvas');
        this.posePreviewCanvasContext =
            this.posePreviewCanvasElement.getContext('2d') || undefined;
        this.handPreviewCanvasElement = document.createElement('canvas');
        this.handPreviewCanvasContext =
            this.handPreviewCanvasElement.getContext('2d') || undefined;
        this.holistic = new Holistic({
            locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`;
            },
        });
        this.holistic.setOptions({
            selfieMode: false,
            modelComplexity: 1,
            smoothLandmarks: true,
            enableSegmentation: false,
            smoothSegmentation: true,
            minDetectionConfidence: 0.6,
            minTrackingConfidence: 0.6,
        });
        this.holistic.onResults((results) => {
            this.onResults(results);
        });
    }
    onResults(results) {
        if (!this.posePreviewCanvasElement ||
            !this.posePreviewCanvasContext ||
            !this.holistic)
            return;
        // 描画用に不必要なランドマークを除去
        let poseLandmarks = [];
        if (results.poseLandmarks) {
            poseLandmarks = JSON.parse(JSON.stringify(results.poseLandmarks));
            this.removeElements(poseLandmarks, [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 15, 16, 17, 18, 19, 20, 21, 22]);
        }
        // キャンバスを塗りつぶし
        this.posePreviewCanvasContext.save();
        this.posePreviewCanvasContext.clearRect(0, 0, this.posePreviewCanvasElement.width, this.posePreviewCanvasElement.height);
        // 検出に使用したフレーム画像を描画
        this.posePreviewCanvasContext.drawImage(results.image, 0, 0, this.posePreviewCanvasElement.width, this.posePreviewCanvasElement.height);
        // 検出に使用したフレーム画像を保持 (加工されていない画像)
        const sourceImageDataUrl = this.posePreviewCanvasElement.toDataURL('image/png');
        // 肘と手をつなぐ線を描画
        this.posePreviewCanvasContext.lineWidth = 5;
        if (poseLandmarks) {
            if (results.rightHandLandmarks) {
                this.posePreviewCanvasContext.strokeStyle = 'white';
                this.connect(this.posePreviewCanvasContext, [
                    [
                        poseLandmarks[POSE_LANDMARKS.RIGHT_ELBOW],
                        results.rightHandLandmarks[0],
                    ],
                ]);
            }
            if (results.leftHandLandmarks) {
                this.posePreviewCanvasContext.strokeStyle = 'white';
                this.connect(this.posePreviewCanvasContext, [
                    [
                        poseLandmarks[POSE_LANDMARKS.LEFT_ELBOW],
                        results.leftHandLandmarks[0],
                    ],
                ]);
            }
        }
        // ポーズのプレビューを描画
        if (poseLandmarks) {
            drawConnectors(this.posePreviewCanvasContext, poseLandmarks, POSE_CONNECTIONS, { color: 'white' });
            drawLandmarks(this.posePreviewCanvasContext, Object.values(POSE_LANDMARKS_LEFT).map((index) => poseLandmarks[index]), { visibilityMin: 0.65, color: 'white', fillColor: 'rgb(255,138,0)' });
            drawLandmarks(this.posePreviewCanvasContext, Object.values(POSE_LANDMARKS_RIGHT).map((index) => poseLandmarks[index]), { visibilityMin: 0.65, color: 'white', fillColor: 'rgb(0,217,231)' });
        }
        // 手のプレビューを描画
        drawConnectors(this.posePreviewCanvasContext, results.rightHandLandmarks, HAND_CONNECTIONS, { color: 'white' });
        drawLandmarks(this.posePreviewCanvasContext, results.rightHandLandmarks, {
            color: 'white',
            fillColor: 'rgb(0,217,231)',
            lineWidth: 2,
            radius: (data) => {
                return lerp(data.from.z, -0.15, 0.1, 10, 1);
            },
        });
        drawConnectors(this.posePreviewCanvasContext, results.leftHandLandmarks, HAND_CONNECTIONS, { color: 'white' });
        drawLandmarks(this.posePreviewCanvasContext, results.leftHandLandmarks, {
            color: 'white',
            fillColor: 'rgb(255,138,0)',
            lineWidth: 2,
            radius: (data) => {
                return lerp(data.from.z, -0.15, 0.1, 10, 1);
            },
        });
        // 手の領域のみのプレビューを生成
        if (this.handPreviewCanvasContext && this.handPreviewCanvasElement) {
            const HAND_PREVIEW_ZOOM = 3;
            const handPreviewBaseY = this.handPreviewCanvasElement.height / 2;
            this.handPreviewCanvasContext.clearRect(0, 0, this.handPreviewCanvasElement.width, this.handPreviewCanvasElement.height);
            if (results.rightHandLandmarks) {
                const rect = this.getRectByLandmarks(results.rightHandLandmarks, results.image.width, results.image.height);
                let handPreviewX = 0;
                let handPreviewY = handPreviewBaseY - (rect[3] * HAND_PREVIEW_ZOOM) / 2;
                this.handPreviewCanvasContext.drawImage(this.posePreviewCanvasElement, rect[0] - 10, rect[1] - 10, rect[2] + 10, rect[3] + 10, handPreviewX, handPreviewY, rect[2] * HAND_PREVIEW_ZOOM, rect[3] * HAND_PREVIEW_ZOOM);
            }
            if (results.leftHandLandmarks) {
                const rect = this.getRectByLandmarks(results.leftHandLandmarks, results.image.width, results.image.height);
                let handPreviewX = this.handPreviewCanvasElement.width - rect[2] * HAND_PREVIEW_ZOOM;
                let handPreviewY = handPreviewBaseY - (rect[3] * HAND_PREVIEW_ZOOM) / 2;
                this.handPreviewCanvasContext.drawImage(this.posePreviewCanvasElement, rect[0] - 10, rect[1] - 10, rect[2] + 10, rect[3] + 10, handPreviewX, handPreviewY, rect[2] * HAND_PREVIEW_ZOOM, rect[3] * HAND_PREVIEW_ZOOM);
            }
        }
        // イベントを送出
        this.onResultsEventEmitter.emit({
            mpResults: results,
            // 加工されていない画像 (PNG)
            sourceImageDataUrl: sourceImageDataUrl,
            // 加工された画像 (PNG)
            posePreviewImageDataUrl: this.posePreviewCanvasElement.toDataURL('image/png'),
        });
        // 完了
        this.posePreviewCanvasContext.restore();
    }
    connect(ctx, connectors) {
        const canvas = ctx.canvas;
        for (const connector of connectors) {
            const from = connector[0];
            const to = connector[1];
            if (from && to) {
                if (from.visibility &&
                    to.visibility &&
                    (from.visibility < 0.1 || to.visibility < 0.1)) {
                    continue;
                }
                ctx.beginPath();
                ctx.moveTo(from.x * canvas.width, from.y * canvas.height);
                ctx.lineTo(to.x * canvas.width, to.y * canvas.height);
                ctx.stroke();
            }
        }
    }
    removeElements(landmarks, elements) {
        for (const element of elements) {
            delete landmarks[element];
        }
    }
    getRectByLandmarks(landmarks, width, height) {
        const leftHandLandmarksX = landmarks.map((landmark) => landmark.x * width);
        const leftHandLandmarksY = landmarks.map((landmark) => landmark.y * height);
        const minX = Math.min(...leftHandLandmarksX);
        const maxX = Math.max(...leftHandLandmarksX);
        const minY = Math.min(...leftHandLandmarksY);
        const maxY = Math.max(...leftHandLandmarksY);
        return [minX, minY, maxX - minX, maxY - minY];
    }
}
PoseExtractorService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.0.4", ngImport: i0, type: PoseExtractorService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
PoseExtractorService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.0.4", ngImport: i0, type: PoseExtractorService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.0.4", ngImport: i0, type: PoseExtractorService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return []; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9zZS1leHRyYWN0b3Iuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1tcC1wb3NlLWV4dHJhY3Rvci9zcmMvbGliL3NlcnZpY2VzL3Bvc2UtZXh0cmFjdG9yLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDekQsT0FBTyxFQUNMLGdCQUFnQixFQUNoQixRQUFRLEVBR1IsZ0JBQWdCLEVBQ2hCLGNBQWMsRUFDZCxtQkFBbUIsRUFDbkIsb0JBQW9CLEdBRXJCLE1BQU0scUJBQXFCLENBQUM7QUFDN0IsT0FBTyxFQUFFLGNBQWMsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7O0FBRS9FOzs7O0dBSUc7QUFFSCxNQUFNLE9BQU8sb0JBQW9CO0lBZS9CO1FBZE8sMEJBQXFCLEdBSXZCLElBQUksWUFBWSxFQUFFLENBQUM7UUFXdEIsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2QsQ0FBQztJQUVNLHlCQUF5QjtRQUM5QixJQUFJLENBQUMsSUFBSSxDQUFDLHdCQUF3QjtZQUFFLE9BQU87UUFDM0MsT0FBTyxJQUFJLENBQUMsd0JBQXdCLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDdkQsQ0FBQztJQUVNLHlCQUF5QjtRQUM5QixJQUFJLENBQUMsSUFBSSxDQUFDLHdCQUF3QjtZQUFFLE9BQU87UUFDM0MsT0FBTyxJQUFJLENBQUMsd0JBQXdCLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDdkQsQ0FBQztJQUVNLEtBQUssQ0FBQyxZQUFZLENBQUMsWUFBOEI7UUFDdEQsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRO1lBQUUsT0FBTztRQUUzQixJQUFJLElBQUksQ0FBQyx3QkFBd0IsRUFBRTtZQUNqQyxJQUFJLENBQUMsd0JBQXdCLENBQUMsS0FBSyxHQUFH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RCxDQUFDOztpSEFuVFUsb0JBQW9CO3FIQUFwQixvQkFBb0I7MkZBQXBCLG9CQUFvQjtrQkFEaEMsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEV2ZW50RW1pdHRlciwgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgSEFORF9DT05ORUNUSU9OUyxcbiAgSG9saXN0aWMsXG4gIE5vcm1hbGl6ZWRMYW5kbWFyayxcbiAgTm9ybWFsaXplZExhbmRtYXJrTGlzdCxcbiAgUE9TRV9DT05ORUNUSU9OUyxcbiAgUE9TRV9MQU5ETUFSS1MsXG4gIFBPU0VfTEFORE1BUktTX0xFRlQsXG4gIFBPU0VfTEFORE1BUktTX1JJR0hULFxuICBSZXN1bHRzLFxufSBmcm9tICdAbWVkaWFwaXBlL2hvbGlzdGljJztcbmltcG9ydCB7IGRyYXdDb25uZWN0b3JzLCBkcmF3TGFuZG1hcmtzLCBsZXJwIH0gZnJvbSAnQG1lZGlhcGlwZS9kcmF3aW5nX3V0aWxzJztcblxuLyoqXG4gKiBNZWRpYVBpcGUg44KS55So44GE44Gm5YuV55S744GL44KJ44Od44O844K644KS5oq95Ye644GZ44KL44Gf44KB44Gu44K144O844OT44K5XG4gKlxuICog4oC7IOOCt+ODs+OCsOODq+ODiOODs+OBquOCteODvOODk+OCueOBp+OBr+OBquOBhOOBn+OCgeOAgUNvbXBvbmVudCDjgacgcHJvdmlkZXJzIOOBq+aMh+WumuOBl+OBpuS9v+eUqOOBmeOCi+OBk+OBqOOCkuaDs+WumlxuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgUG9zZUV4dHJhY3RvclNlcnZpY2Uge1xuICBwdWJsaWMgb25SZXN1bHRzRXZlbnRFbWl0dGVyOiBFdmVudEVtaXR0ZXI8e1xuICAgIG1wUmVzdWx0czogUmVzdWx0cztcbiAgICBzb3VyY2VJbWFnZURhdGFVcmw6IHN0cmluZztcbiAgICBwb3NlUHJldmlld0ltYWdlRGF0YVVybDogc3RyaW5nO1xuICB9PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICBwcml2YXRlIGhvbGlzdGljPzogSG9saXN0aWM7XG5cbiAgcHJpdmF0ZSBwb3NlUHJldmlld0NhbnZhc0VsZW1lbnQ/OiBIVE1MQ2FudmFzRWxlbWVudDtcbiAgcHJpdmF0ZSBwb3NlUHJldmlld0NhbnZhc0NvbnRleHQ/OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQ7XG5cbiAgcHJpdmF0ZSBoYW5kUHJldmlld0NhbnZhc0VsZW1lbnQ/OiBIVE1MQ2FudmFzRWxlbWVudDtcbiAgcHJpdmF0ZSBoYW5kUHJldmlld0NhbnZhc0NvbnRleHQ/OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQ7XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5pbml0KCk7XG4gIH1cblxuICBwdWJsaWMgZ2V0UG9zZVByZXZpZXdNZWRpYVN0cmVhbSgpOiBNZWRpYVN0cmVhbSB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKCF0aGlzLnBvc2VQcmV2aWV3Q2FudmFzRWxlbWVudCkgcmV0dXJuO1xuICAgIHJldHVybiB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzRWxlbWVudC5jYXB0dXJlU3RyZWFtKCk7XG4gIH1cblxuICBwdWJsaWMgZ2V0SGFuZFByZXZpZXdNZWRpYVN0cmVhbSgpOiBNZWRpYVN0cmVhbSB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKCF0aGlzLmhhbmRQcmV2aWV3Q2FudmFzRWxlbWVudCkgcmV0dXJuO1xuICAgIHJldHVybiB0aGlzLmhhbmRQcmV2aWV3Q2FudmFzRWxlbWVudC5jYXB0dXJlU3RyZWFtKCk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgb25WaWRlb0ZyYW1lKHZpZGVvRWxlbWVudDogSFRNTFZpZGVvRWxlbWVudCkge1xuICAgIGlmICghdGhpcy5ob2xpc3RpYykgcmV0dXJuO1xuXG4gICAgaWYgKHRoaXMucG9zZVByZXZpZXdDYW52YXNFbGVtZW50KSB7XG4gICAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzRWxlbWVudC53aWR0aCA9IHZpZGVvRWxlbWVudC52aWRlb1dpZHRoO1xuICAgICAgdGhpcy5wb3NlUHJldmlld0NhbnZhc0VsZW1lbnQuaGVpZ2h0ID0gdmlkZW9FbGVtZW50LnZpZGVvSGVpZ2h0O1xuICAgIH1cblxuICAgIGlmICh0aGlzLmhhbmRQcmV2aWV3Q2FudmFzRWxlbWVudCkge1xuICAgICAgdGhpcy5oYW5kUHJldmlld0NhbnZhc0VsZW1lbnQud2lkdGggPSB2aWRlb0VsZW1lbnQudmlkZW9XaWR0aDtcbiAgICAgIHRoaXMuaGFuZFByZXZpZXdDYW52YXNFbGVtZW50LmhlaWdodCA9IHZpZGVvRWxlbWVudC52aWRlb0hlaWdodDtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLmhvbGlzdGljLnNlbmQoeyBpbWFnZTogdmlkZW9FbGVtZW50IH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0KCkge1xuICAgIHRoaXMucG9zZVByZXZpZXdDYW52YXNFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7XG4gICAgdGhpcy5wb3NlUHJldmlld0NhbnZhc0NvbnRleHQgPVxuICAgICAgdGhpcy5wb3NlUHJldmlld0NhbnZhc0VsZW1lbnQuZ2V0Q29udGV4dCgnMmQnKSB8fCB1bmRlZmluZWQ7XG5cbiAgICB0aGlzLmhhbmRQcmV2aWV3Q2FudmFzRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xuICAgIHRoaXMuaGFuZFByZXZpZXdDYW52YXNDb250ZXh0ID1cbiAgICAgIHRoaXMuaGFuZFByZXZpZXdDYW52YXNFbGVtZW50LmdldENvbnRleHQoJzJkJykgfHwgdW5kZWZpbmVkO1xuXG4gICAgdGhpcy5ob2xpc3RpYyA9IG5ldyBIb2xpc3RpYyh7XG4gICAgICBsb2NhdGVGaWxlOiAoZmlsZSkgPT4ge1xuICAgICAgICByZXR1cm4gYGh0dHBzOi8vY2RuLmpzZGVsaXZyLm5ldC9ucG0vQG1lZGlhcGlwZS9ob2xpc3RpYy8ke2ZpbGV9YDtcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICB0aGlzLmhvbGlzdGljLnNldE9wdGlvbnMoe1xuICAgICAgc2VsZmllTW9kZTogZmFsc2UsXG4gICAgICBtb2RlbENvbXBsZXhpdHk6IDEsXG4gICAgICBzbW9vdGhMYW5kbWFya3M6IHRydWUsXG4gICAgICBlbmFibGVTZWdtZW50YXRpb246IGZhbHNlLFxuICAgICAgc21vb3RoU2VnbWVudGF0aW9uOiB0cnVlLFxuICAgICAgbWluRGV0ZWN0aW9uQ29uZmlkZW5jZTogMC42LFxuICAgICAgbWluVHJhY2tpbmdDb25maWRlbmNlOiAwLjYsXG4gICAgfSk7XG5cbiAgICB0aGlzLmhvbGlzdGljLm9uUmVzdWx0cygocmVzdWx0czogUmVzdWx0cykgPT4ge1xuICAgICAgdGhpcy5vblJlc3VsdHMocmVzdWx0cyk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIG9uUmVzdWx0cyhyZXN1bHRzOiBSZXN1bHRzKSB7XG4gICAgaWYgKFxuICAgICAgIXRoaXMucG9zZVByZXZpZXdDYW52YXNFbGVtZW50IHx8XG4gICAgICAhdGhpcy5wb3NlUHJldmlld0NhbnZhc0NvbnRleHQgfHxcbiAgICAgICF0aGlzLmhvbGlzdGljXG4gICAgKVxuICAgICAgcmV0dXJuO1xuXG4gICAgLy8g5o+P55S755So44Gr5LiN5b+F6KaB44Gq44Op44Oz44OJ44Oe44O844Kv44KS6Zmk5Y67XG4gICAgbGV0IHBvc2VMYW5kbWFya3M6IE5vcm1hbGl6ZWRMYW5kbWFya0xpc3QgPSBbXTtcbiAgICBpZiAocmVzdWx0cy5wb3NlTGFuZG1hcmtzKSB7XG4gICAgICBwb3NlTGFuZG1hcmtzID0gSlNPTi5wYXJzZShcbiAgICAgICAgSlNPTi5zdHJpbmdpZnkocmVzdWx0cy5wb3NlTGFuZG1hcmtzKVxuICAgICAgKSBhcyBOb3JtYWxpemVkTGFuZG1hcmtMaXN0O1xuICAgICAgdGhpcy5yZW1vdmVFbGVtZW50cyhcbiAgICAgICAgcG9zZUxhbmRtYXJrcyxcbiAgICAgICAgWzAsIDEsIDIsIDMsIDQsIDUsIDYsIDcsIDgsIDksIDEwLCAxNSwgMTYsIDE3LCAxOCwgMTksIDIwLCAyMSwgMjJdXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIOOCreODo+ODs+ODkOOCueOCkuWhl+OCiuOBpOOBtuOBl1xuICAgIHRoaXMucG9zZVByZXZpZXdDYW52YXNDb250ZXh0LnNhdmUoKTtcbiAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzQ29udGV4dC5jbGVhclJlY3QoXG4gICAgICAwLFxuICAgICAgMCxcbiAgICAgIHRoaXMucG9zZVByZXZpZXdDYW52YXNFbGVtZW50LndpZHRoLFxuICAgICAgdGhpcy5wb3NlUHJldmlld0NhbnZhc0VsZW1lbnQuaGVpZ2h0XG4gICAgKTtcblxuICAgIC8vIOaknOWHuuOBq+S9v+eUqOOBl+OBn+ODleODrOODvOODoOeUu+WDj+OCkuaPj+eUu1xuICAgIHRoaXMucG9zZVByZXZpZXdDYW52YXNDb250ZXh0LmRyYXdJbWFnZShcbiAgICAgIHJlc3VsdHMuaW1hZ2UsXG4gICAgICAwLFxuICAgICAgMCxcbiAgICAgIHRoaXMucG9zZVByZXZpZXdDYW52YXNFbGVtZW50LndpZHRoLFxuICAgICAgdGhpcy5wb3NlUHJldmlld0NhbnZhc0VsZW1lbnQuaGVpZ2h0XG4gICAgKTtcblxuICAgIC8vIOaknOWHuuOBq+S9v+eUqOOBl+OBn+ODleODrOODvOODoOeUu+WDj+OCkuS/neaMgSAo5Yqg5bel44GV44KM44Gm44GE44Gq44GE55S75YOPKVxuICAgIGNvbnN0IHNvdXJjZUltYWdlRGF0YVVybCA9XG4gICAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzRWxlbWVudC50b0RhdGFVUkwoJ2ltYWdlL3BuZycpO1xuXG4gICAgLy8g6IKY44Go5omL44KS44Gk44Gq44GQ57ea44KS5o+P55S7XG4gICAgdGhpcy5wb3NlUHJldmlld0NhbnZhc0NvbnRleHQubGluZVdpZHRoID0gNTtcbiAgICBpZiAocG9zZUxhbmRtYXJrcykge1xuICAgICAgaWYgKHJlc3VsdHMucmlnaHRIYW5kTGFuZG1hcmtzKSB7XG4gICAgICAgIHRoaXMucG9zZVByZXZpZXdDYW52YXNDb250ZXh0LnN0cm9rZVN0eWxlID0gJ3doaXRlJztcbiAgICAgICAgdGhpcy5jb25uZWN0KHRoaXMucG9zZVByZXZpZXdDYW52YXNDb250ZXh0LCBbXG4gICAgICAgICAgW1xuICAgICAgICAgICAgcG9zZUxhbmRtYXJrc1tQT1NFX0xBTkRNQVJLUy5SSUdIVF9FTEJPV10sXG4gICAgICAgICAgICByZXN1bHRzLnJpZ2h0SGFuZExhbmRtYXJrc1swXSxcbiAgICAgICAgICBdLFxuICAgICAgICBdKTtcbiAgICAgIH1cbiAgICAgIGlmIChyZXN1bHRzLmxlZnRIYW5kTGFuZG1hcmtzKSB7XG4gICAgICAgIHRoaXMucG9zZVByZXZpZXdDYW52YXNDb250ZXh0LnN0cm9rZVN0eWxlID0gJ3doaXRlJztcbiAgICAgICAgdGhpcy5jb25uZWN0KHRoaXMucG9zZVByZXZpZXdDYW52YXNDb250ZXh0LCBbXG4gICAgICAgICAgW1xuICAgICAgICAgICAgcG9zZUxhbmRtYXJrc1tQT1NFX0xBTkRNQVJLUy5MRUZUX0VMQk9XXSxcbiAgICAgICAgICAgIHJlc3VsdHMubGVmdEhhbmRMYW5kbWFya3NbMF0sXG4gICAgICAgICAgXSxcbiAgICAgICAgXSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8g44Od44O844K644Gu44OX44Os44OT44Ol44O844KS5o+P55S7XG4gICAgaWYgKHBvc2VMYW5kbWFya3MpIHtcbiAgICAgIGRyYXdDb25uZWN0b3JzKFxuICAgICAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzQ29udGV4dCxcbiAgICAgICAgcG9zZUxhbmRtYXJrcyxcbiAgICAgICAgUE9TRV9DT05ORUNUSU9OUyxcbiAgICAgICAgeyBjb2xvcjogJ3doaXRlJyB9XG4gICAgICApO1xuICAgICAgZHJhd0xhbmRtYXJrcyhcbiAgICAgICAgdGhpcy5wb3NlUHJldmlld0NhbnZhc0NvbnRleHQsXG4gICAgICAgIE9iamVjdC52YWx1ZXMoUE9TRV9MQU5ETUFSS1NfTEVGVCkubWFwKChpbmRleCkgPT4gcG9zZUxhbmRtYXJrc1tpbmRleF0pLFxuICAgICAgICB7IHZpc2liaWxpdHlNaW46IDAuNjUsIGNvbG9yOiAnd2hpdGUnLCBmaWxsQ29sb3I6ICdyZ2IoMjU1LDEzOCwwKScgfVxuICAgICAgKTtcbiAgICAgIGRyYXdMYW5kbWFya3MoXG4gICAgICAgIHRoaXMucG9zZVByZXZpZXdDYW52YXNDb250ZXh0LFxuICAgICAgICBPYmplY3QudmFsdWVzKFBPU0VfTEFORE1BUktTX1JJR0hUKS5tYXAoXG4gICAgICAgICAgKGluZGV4KSA9PiBwb3NlTGFuZG1hcmtzW2luZGV4XVxuICAgICAgICApLFxuICAgICAgICB7IHZpc2liaWxpdHlNaW46IDAuNjUsIGNvbG9yOiAnd2hpdGUnLCBmaWxsQ29sb3I6ICdyZ2IoMCwyMTcsMjMxKScgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyDmiYvjga7jg5fjg6zjg5Pjg6Xjg7zjgpLmj4/nlLtcbiAgICBkcmF3Q29ubmVjdG9ycyhcbiAgICAgIHRoaXMucG9zZVByZXZpZXdDYW52YXNDb250ZXh0LFxuICAgICAgcmVzdWx0cy5yaWdodEhhbmRMYW5kbWFya3MsXG4gICAgICBIQU5EX0NPTk5FQ1RJT05TLFxuICAgICAgeyBjb2xvcjogJ3doaXRlJyB9XG4gICAgKTtcbiAgICBkcmF3TGFuZG1hcmtzKHRoaXMucG9zZVByZXZpZXdDYW52YXNDb250ZXh0LCByZXN1bHRzLnJpZ2h0SGFuZExhbmRtYXJrcywge1xuICAgICAgY29sb3I6ICd3aGl0ZScsXG4gICAgICBmaWxsQ29sb3I6ICdyZ2IoMCwyMTcsMjMxKScsXG4gICAgICBsaW5lV2lkdGg6IDIsXG4gICAgICByYWRpdXM6IChkYXRhOiBhbnkpID0+IHtcbiAgICAgICAgcmV0dXJuIGxlcnAoZGF0YS5mcm9tLnosIC0wLjE1LCAwLjEsIDEwLCAxKTtcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgZHJhd0Nvbm5lY3RvcnMoXG4gICAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzQ29udGV4dCxcbiAgICAgIHJlc3VsdHMubGVmdEhhbmRMYW5kbWFya3MsXG4gICAgICBIQU5EX0NPTk5FQ1RJT05TLFxuICAgICAgeyBjb2xvcjogJ3doaXRlJyB9XG4gICAgKTtcbiAgICBkcmF3TGFuZG1hcmtzKHRoaXMucG9zZVByZXZpZXdDYW52YXNDb250ZXh0LCByZXN1bHRzLmxlZnRIYW5kTGFuZG1hcmtzLCB7XG4gICAgICBjb2xvcjogJ3doaXRlJyxcbiAgICAgIGZpbGxDb2xvcjogJ3JnYigyNTUsMTM4LDApJyxcbiAgICAgIGxpbmVXaWR0aDogMixcbiAgICAgIHJhZGl1czogKGRhdGE6IGFueSkgPT4ge1xuICAgICAgICByZXR1cm4gbGVycChkYXRhLmZyb20ueiwgLTAuMTUsIDAuMSwgMTAsIDEpO1xuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIOaJi+OBrumgmOWfn+OBruOBv+OBruODl+ODrOODk+ODpeODvOOCkueUn+aIkFxuICAgIGlmICh0aGlzLmhhbmRQcmV2aWV3Q2FudmFzQ29udGV4dCAmJiB0aGlzLmhhbmRQcmV2aWV3Q2FudmFzRWxlbWVudCkge1xuICAgICAgY29uc3QgSEFORF9QUkVWSUVXX1pPT00gPSAzO1xuICAgICAgY29uc3QgaGFuZFByZXZpZXdCYXNlWSA9IHRoaXMuaGFuZFByZXZpZXdDYW52YXNFbGVtZW50LmhlaWdodCAvIDI7XG5cbiAgICAgIHRoaXMuaGFuZFByZXZpZXdDYW52YXNDb250ZXh0LmNsZWFyUmVjdChcbiAgICAgICAgMCxcbiAgICAgICAgMCxcbiAgICAgICAgdGhpcy5oYW5kUHJldmlld0NhbnZhc0VsZW1lbnQud2lkdGgsXG4gICAgICAgIHRoaXMuaGFuZFByZXZpZXdDYW52YXNFbGVtZW50LmhlaWdodFxuICAgICAgKTtcblxuICAgICAgaWYgKHJlc3VsdHMucmlnaHRIYW5kTGFuZG1hcmtzKSB7XG4gICAgICAgIGNvbnN0IHJlY3QgPSB0aGlzLmdldFJlY3RCeUxhbmRtYXJrcyhcbiAgICAgICAgICByZXN1bHRzLnJpZ2h0SGFuZExhbmRtYXJrcyxcbiAgICAgICAgICByZXN1bHRzLmltYWdlLndpZHRoLFxuICAgICAgICAgIHJlc3VsdHMuaW1hZ2UuaGVpZ2h0XG4gICAgICAgICk7XG5cbiAgICAgICAgbGV0IGhhbmRQcmV2aWV3WCA9IDA7XG4gICAgICAgIGxldCBoYW5kUHJldmlld1kgPSBoYW5kUHJldmlld0Jhc2VZIC0gKHJlY3RbM10gKiBIQU5EX1BSRVZJRVdfWk9PTSkgLyAyO1xuXG4gICAgICAgIHRoaXMuaGFuZFByZXZpZXdDYW52YXNDb250ZXh0LmRyYXdJbWFnZShcbiAgICAgICAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzRWxlbWVudCxcbiAgICAgICAgICByZWN0WzBdIC0gMTAsXG4gICAgICAgICAgcmVjdFsxXSAtIDEwLFxuICAgICAgICAgIHJlY3RbMl0gKyAxMCxcbiAgICAgICAgICByZWN0WzNdICsgMTAsXG4gICAgICAgICAgaGFuZFByZXZpZXdYLFxuICAgICAgICAgIGhhbmRQcmV2aWV3WSxcbiAgICAgICAgICByZWN0WzJdICogSEFORF9QUkVWSUVXX1pPT00sXG4gICAgICAgICAgcmVjdFszXSAqIEhBTkRfUFJFVklFV19aT09NXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGlmIChyZXN1bHRzLmxlZnRIYW5kTGFuZG1hcmtzKSB7XG4gICAgICAgIGNvbnN0IHJlY3QgPSB0aGlzLmdldFJlY3RCeUxhbmRtYXJrcyhcbiAgICAgICAgICByZXN1bHRzLmxlZnRIYW5kTGFuZG1hcmtzLFxuICAgICAgICAgIHJlc3VsdHMuaW1hZ2Uud2lkdGgsXG4gICAgICAgICAgcmVzdWx0cy5pbWFnZS5oZWlnaHRcbiAgICAgICAgKTtcblxuICAgICAgICBsZXQgaGFuZFByZXZpZXdYID1cbiAgICAgICAgICB0aGlzLmhhbmRQcmV2aWV3Q2FudmFzRWxlbWVudC53aWR0aCAtIHJlY3RbMl0gKiBIQU5EX1BSRVZJRVdfWk9PTTtcbiAgICAgICAgbGV0IGhhbmRQcmV2aWV3WSA9IGhhbmRQcmV2aWV3QmFzZVkgLSAocmVjdFszXSAqIEhBTkRfUFJFVklFV19aT09NKSAvIDI7XG5cbiAgICAgICAgdGhpcy5oYW5kUHJldmlld0NhbnZhc0NvbnRleHQuZHJhd0ltYWdlKFxuICAgICAgICAgIHRoaXMucG9zZVByZXZpZXdDYW52YXNFbGVtZW50LFxuICAgICAgICAgIHJlY3RbMF0gLSAxMCxcbiAgICAgICAgICByZWN0WzFdIC0gMTAsXG4gICAgICAgICAgcmVjdFsyXSArIDEwLFxuICAgICAgICAgIHJlY3RbM10gKyAxMCxcbiAgICAgICAgICBoYW5kUHJldmlld1gsXG4gICAgICAgICAgaGFuZFByZXZpZXdZLFxuICAgICAgICAgIHJlY3RbMl0gKiBIQU5EX1BSRVZJRVdfWk9PTSxcbiAgICAgICAgICByZWN0WzNdICogSEFORF9QUkVWSUVXX1pPT01cbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyDjgqTjg5njg7Pjg4jjgpLpgIHlh7pcbiAgICB0aGlzLm9uUmVzdWx0c0V2ZW50RW1pdHRlci5lbWl0KHtcbiAgICAgIG1wUmVzdWx0czogcmVzdWx0cyxcbiAgICAgIC8vIOWKoOW3peOBleOCjOOBpuOBhOOBquOBhOeUu+WDjyAoUE5HKVxuICAgICAgc291cmNlSW1hZ2VEYXRhVXJsOiBzb3VyY2VJbWFnZURhdGFVcmwsXG4gICAgICAvLyDliqDlt6XjgZXjgozjgZ/nlLvlg48gKFBORylcbiAgICAgIHBvc2VQcmV2aWV3SW1hZ2VEYXRhVXJsOlxuICAgICAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzRWxlbWVudC50b0RhdGFVUkwoJ2ltYWdlL3BuZycpLFxuICAgIH0pO1xuXG4gICAgLy8g5a6M5LqGXG4gICAgdGhpcy5wb3NlUHJldmlld0NhbnZhc0NvbnRleHQucmVzdG9yZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBjb25uZWN0KFxuICAgIGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJELFxuICAgIGNvbm5lY3RvcnM6IEFycmF5PFtOb3JtYWxpemVkTGFuZG1hcmssIE5vcm1hbGl6ZWRMYW5kbWFya10+XG4gICkge1xuICAgIGNvbnN0IGNhbnZhcyA9IGN0eC5jYW52YXM7XG4gICAgZm9yIChjb25zdCBjb25uZWN0b3Igb2YgY29ubmVjdG9ycykge1xuICAgICAgY29uc3QgZnJvbSA9IGNvbm5lY3RvclswXTtcbiAgICAgIGNvbnN0IHRvID0gY29ubmVjdG9yWzFdO1xuICAgICAgaWYgKGZyb20gJiYgdG8pIHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgIGZyb20udmlzaWJpbGl0eSAmJlxuICAgICAgICAgIHRvLnZpc2liaWxpdHkgJiZcbiAgICAgICAgICAoZnJvbS52aXNpYmlsaXR5IDwgMC4xIHx8IHRvLnZpc2liaWxpdHkgPCAwLjEpXG4gICAgICAgICkge1xuICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICAgIGN0eC5iZWdpblBhdGgoKTtcbiAgICAgICAgY3R4Lm1vdmVUbyhmcm9tLnggKiBjYW52YXMud2lkdGgsIGZyb20ueSAqIGNhbnZhcy5oZWlnaHQpO1xuICAgICAgICBjdHgubGluZVRvKHRvLnggKiBjYW52YXMud2lkdGgsIHRvLnkgKiBjYW52YXMuaGVpZ2h0KTtcbiAgICAgICAgY3R4LnN0cm9rZSgpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlRWxlbWVudHMoXG4gICAgbGFuZG1hcmtzOiBOb3JtYWxpemVkTGFuZG1hcmtMaXN0LFxuICAgIGVsZW1lbnRzOiBudW1iZXJbXVxuICApIHtcbiAgICBmb3IgKGNvbnN0IGVsZW1lbnQgb2YgZWxlbWVudHMpIHtcbiAgICAgIGRlbGV0ZSBsYW5kbWFya3NbZWxlbWVudF07XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRSZWN0QnlMYW5kbWFya3MobGFuZG1hcmtzOiBhbnlbXSwgd2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIpIHtcbiAgICBjb25zdCBsZWZ0SGFuZExhbmRtYXJrc1ggPSBsYW5kbWFya3MubWFwKChsYW5kbWFyaykgPT4gbGFuZG1hcmsueCAqIHdpZHRoKTtcbiAgICBjb25zdCBsZWZ0SGFuZExhbmRtYXJrc1kgPSBsYW5kbWFya3MubWFwKChsYW5kbWFyaykgPT4gbGFuZG1hcmsueSAqIGhlaWdodCk7XG4gICAgY29uc3QgbWluWCA9IE1hdGgubWluKC4uLmxlZnRIYW5kTGFuZG1hcmtzWCk7XG4gICAgY29uc3QgbWF4WCA9IE1hdGgubWF4KC4uLmxlZnRIYW5kTGFuZG1hcmtzWCk7XG4gICAgY29uc3QgbWluWSA9IE1hdGgubWluKC4uLmxlZnRIYW5kTGFuZG1hcmtzWSk7XG4gICAgY29uc3QgbWF4WSA9IE1hdGgubWF4KC4uLmxlZnRIYW5kTGFuZG1hcmtzWSk7XG4gICAgcmV0dXJuIFttaW5YLCBtaW5ZLCBtYXhYIC0gbWluWCwgbWF4WSAtIG1pblldO1xuICB9XG59XG4iXX0=