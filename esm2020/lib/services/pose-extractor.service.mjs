import { EventEmitter, Injectable } from '@angular/core';
import { HAND_CONNECTIONS, Holistic, POSE_CONNECTIONS, POSE_LANDMARKS, POSE_LANDMARKS_LEFT, POSE_LANDMARKS_RIGHT, } from '@mediapipe/holistic';
import { drawConnectors, drawLandmarks, lerp } from '@mediapipe/drawing_utils';
import * as i0 from "@angular/core";
/**
 * MediaPipe を用いて動画からポーズを抽出するためのサービス
 *
 * ※ シングルトンなサービスではないため、Component で providers に指定して使用することを想定
 */
export class PoseExtractorService {
    constructor() {
        this.onResultsEventEmitter = new EventEmitter();
        this.init();
    }
    getPosePreviewMediaStream() {
        if (!this.posePreviewCanvasElement)
            return;
        return this.posePreviewCanvasElement.captureStream();
    }
    getHandPreviewMediaStream() {
        if (!this.handPreviewCanvasElement)
            return;
        return this.handPreviewCanvasElement.captureStream();
    }
    getFacePreviewMediaStream() {
        if (!this.facePreviewCanvasElement)
            return;
        return this.facePreviewCanvasElement.captureStream();
    }
    async onVideoFrame(input) {
        if (!this.holistic)
            return;
        if (input instanceof HTMLVideoElement) {
            if (this.posePreviewCanvasElement) {
                this.posePreviewCanvasElement.width = input.videoWidth;
                this.posePreviewCanvasElement.height = input.videoHeight;
            }
            if (this.handPreviewCanvasElement) {
                this.handPreviewCanvasElement.width = input.videoWidth;
                this.handPreviewCanvasElement.height = input.videoHeight;
            }
            if (this.facePreviewCanvasElement) {
                this.facePreviewCanvasElement.width = input.videoWidth;
                this.facePreviewCanvasElement.height = input.videoHeight;
            }
        }
        else if (input instanceof HTMLCanvasElement) {
            if (this.posePreviewCanvasElement) {
                this.posePreviewCanvasElement.width = input.width;
                this.posePreviewCanvasElement.height = input.height;
            }
            if (this.handPreviewCanvasElement) {
                this.handPreviewCanvasElement.width = input.width;
                this.handPreviewCanvasElement.height = input.height;
            }
            if (this.facePreviewCanvasElement) {
                this.facePreviewCanvasElement.width = input.width;
                this.facePreviewCanvasElement.height = input.height;
            }
        }
        await this.holistic.send({ image: input });
    }
    init() {
        this.posePreviewCanvasElement = document.createElement('canvas');
        this.posePreviewCanvasContext =
            this.posePreviewCanvasElement.getContext('2d') || undefined;
        this.handPreviewCanvasElement = document.createElement('canvas');
        this.handPreviewCanvasContext =
            this.handPreviewCanvasElement.getContext('2d') || undefined;
        this.facePreviewCanvasElement = document.createElement('canvas');
        this.facePreviewCanvasContext =
            this.facePreviewCanvasElement.getContext('2d') || undefined;
        this.holistic = new Holistic({
            locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`;
            },
        });
        this.holistic.setOptions({
            selfieMode: false,
            modelComplexity: 1,
            smoothLandmarks: true,
            enableSegmentation: false,
            smoothSegmentation: true,
            minDetectionConfidence: 0.6,
            minTrackingConfidence: 0.6,
        });
        this.holistic.onResults((results) => {
            this.onResults(results);
        });
    }
    onResults(results) {
        if (!this.posePreviewCanvasElement ||
            !this.posePreviewCanvasContext ||
            !this.holistic)
            return;
        // 描画用に不必要なランドマークを除去
        let poseLandmarks = [];
        if (results.poseLandmarks) {
            poseLandmarks = JSON.parse(JSON.stringify(results.poseLandmarks));
            this.removeElements(poseLandmarks, [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 15, 16, 17, 18, 19, 20, 21, 22]);
        }
        // キャンバスを塗りつぶし
        this.posePreviewCanvasContext.save();
        this.posePreviewCanvasContext.clearRect(0, 0, this.posePreviewCanvasElement.width, this.posePreviewCanvasElement.height);
        // 検出に使用したフレーム画像を描画
        this.posePreviewCanvasContext.drawImage(results.image, 0, 0, this.posePreviewCanvasElement.width, this.posePreviewCanvasElement.height);
        // 検出に使用したフレーム画像を保持 (加工されていない画像)
        const sourceImageDataUrl = this.posePreviewCanvasElement.toDataURL('image/png');
        // 肘と手をつなぐ線を描画
        this.posePreviewCanvasContext.lineWidth = 5;
        if (poseLandmarks) {
            if (results.rightHandLandmarks) {
                this.posePreviewCanvasContext.strokeStyle = 'white';
                this.connect(this.posePreviewCanvasContext, [
                    [
                        poseLandmarks[POSE_LANDMARKS.RIGHT_ELBOW],
                        results.rightHandLandmarks[0],
                    ],
                ]);
            }
            if (results.leftHandLandmarks) {
                this.posePreviewCanvasContext.strokeStyle = 'white';
                this.connect(this.posePreviewCanvasContext, [
                    [
                        poseLandmarks[POSE_LANDMARKS.LEFT_ELBOW],
                        results.leftHandLandmarks[0],
                    ],
                ]);
            }
        }
        // ポーズのプレビューを描画
        if (poseLandmarks) {
            drawConnectors(this.posePreviewCanvasContext, poseLandmarks, POSE_CONNECTIONS, { color: 'white' });
            drawLandmarks(this.posePreviewCanvasContext, Object.values(POSE_LANDMARKS_LEFT).map((index) => poseLandmarks[index]), { visibilityMin: 0.65, color: 'white', fillColor: 'rgb(255,138,0)' });
            drawLandmarks(this.posePreviewCanvasContext, Object.values(POSE_LANDMARKS_RIGHT).map((index) => poseLandmarks[index]), { visibilityMin: 0.65, color: 'white', fillColor: 'rgb(0,217,231)' });
        }
        // 手のプレビューを描画
        drawConnectors(this.posePreviewCanvasContext, results.rightHandLandmarks, HAND_CONNECTIONS, { color: 'white' });
        drawLandmarks(this.posePreviewCanvasContext, results.rightHandLandmarks, {
            color: 'white',
            fillColor: 'rgb(0,217,231)',
            lineWidth: 2,
            radius: (data) => {
                return lerp(data.from.z, -0.15, 0.1, 10, 1);
            },
        });
        drawConnectors(this.posePreviewCanvasContext, results.leftHandLandmarks, HAND_CONNECTIONS, { color: 'white' });
        drawLandmarks(this.posePreviewCanvasContext, results.leftHandLandmarks, {
            color: 'white',
            fillColor: 'rgb(255,138,0)',
            lineWidth: 2,
            radius: (data) => {
                return lerp(data.from.z, -0.15, 0.1, 10, 1);
            },
        });
        // 手の領域のみのプレビュー画像を生成
        if (this.handPreviewCanvasContext && this.handPreviewCanvasElement) {
            const HAND_PREVIEW_ZOOM = 3;
            const handPreviewBaseY = this.handPreviewCanvasElement.height / 2;
            this.handPreviewCanvasContext.clearRect(0, 0, this.handPreviewCanvasElement.width, this.handPreviewCanvasElement.height);
            if (results.rightHandLandmarks) {
                const rect = this.getRectByLandmarks(results.rightHandLandmarks, results.image.width, results.image.height);
                let handPreviewX = 0;
                let handPreviewY = handPreviewBaseY - (rect[3] * HAND_PREVIEW_ZOOM) / 2;
                this.handPreviewCanvasContext.drawImage(this.posePreviewCanvasElement, rect[0] - 10, rect[1] - 10, rect[2] + 10, rect[3] + 10, handPreviewX, handPreviewY, rect[2] * HAND_PREVIEW_ZOOM, rect[3] * HAND_PREVIEW_ZOOM);
            }
            if (results.leftHandLandmarks) {
                const rect = this.getRectByLandmarks(results.leftHandLandmarks, results.image.width, results.image.height);
                let handPreviewX = this.handPreviewCanvasElement.width - rect[2] * HAND_PREVIEW_ZOOM;
                let handPreviewY = handPreviewBaseY - (rect[3] * HAND_PREVIEW_ZOOM) / 2;
                this.handPreviewCanvasContext.drawImage(this.posePreviewCanvasElement, rect[0] - 10, rect[1] - 10, rect[2] + 10, rect[3] + 10, handPreviewX, handPreviewY, rect[2] * HAND_PREVIEW_ZOOM, rect[3] * HAND_PREVIEW_ZOOM);
            }
        }
        // 顔の領域のみのフレーム画像を生成
        if (this.facePreviewCanvasContext && this.facePreviewCanvasElement) {
            const FACE_PREVIEW_ZOOM = 1.25;
            const facePreviewBaseY = this.facePreviewCanvasElement.height / 2;
            if (results.faceLandmarks) {
                const rect = this.getRectByLandmarks(results.faceLandmarks, results.image.width, results.image.height);
                const rectWidth = rect[2] * FACE_PREVIEW_ZOOM;
                const rectHeight = rect[3] * FACE_PREVIEW_ZOOM;
                this.facePreviewCanvasElement.width = rectWidth;
                this.facePreviewCanvasElement.height = rectHeight;
                this.facePreviewCanvasContext.clearRect(0, 0, rectWidth, rectHeight);
                this.facePreviewCanvasContext.drawImage(results.image, rect[0] - 10, rect[1] - 10, rect[2] + 10, rect[3] + 10, 0, 0, rectWidth, rectHeight);
            }
            else {
                this.facePreviewCanvasContext.clearRect(0, 0, this.facePreviewCanvasElement.width, this.facePreviewCanvasElement.height);
            }
        }
        // イベントを送出
        this.onResultsEventEmitter.emit({
            mpResults: results,
            // 加工されていない画像 (PNG)
            frameImageDataUrl: sourceImageDataUrl,
            // 加工された画像 (PNG)
            posePreviewImageDataUrl: this.posePreviewCanvasElement.toDataURL('image/png'),
            // 顔のみの画像 (PNG)
            faceFrameImageDataUrl: results.faceLandmarks
                ? this.facePreviewCanvasElement.toDataURL('image/png')
                : undefined,
        });
        // 完了
        this.posePreviewCanvasContext.restore();
    }
    connect(ctx, connectors) {
        const canvas = ctx.canvas;
        for (const connector of connectors) {
            const from = connector[0];
            const to = connector[1];
            if (from && to) {
                if (from.visibility &&
                    to.visibility &&
                    (from.visibility < 0.1 || to.visibility < 0.1)) {
                    continue;
                }
                ctx.beginPath();
                ctx.moveTo(from.x * canvas.width, from.y * canvas.height);
                ctx.lineTo(to.x * canvas.width, to.y * canvas.height);
                ctx.stroke();
            }
        }
    }
    removeElements(landmarks, elements) {
        for (const element of elements) {
            delete landmarks[element];
        }
    }
    getRectByLandmarks(landmarks, width, height) {
        const leftHandLandmarksX = landmarks.map((landmark) => landmark.x * width);
        const leftHandLandmarksY = landmarks.map((landmark) => landmark.y * height);
        const minX = Math.min(...leftHandLandmarksX);
        const maxX = Math.max(...leftHandLandmarksX);
        const minY = Math.min(...leftHandLandmarksY);
        const maxY = Math.max(...leftHandLandmarksY);
        return [minX, minY, maxX - minX, maxY - minY];
    }
}
PoseExtractorService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.0.4", ngImport: i0, type: PoseExtractorService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
PoseExtractorService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.0.4", ngImport: i0, type: PoseExtractorService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.0.4", ngImport: i0, type: PoseExtractorService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return []; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9zZS1leHRyYWN0b3Iuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1tcC1wb3NlLWV4dHJhY3Rvci9zcmMvbGliL3NlcnZpY2VzL3Bvc2UtZXh0cmFjdG9yLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDekQsT0FBTyxFQUNMLGdCQUFnQixFQUNoQixRQUFRLEVBR1IsZ0JBQWdCLEVBQ2hCLGNBQWMsRUFDZCxtQkFBbUIsRUFDbkIsb0JBQW9CLEdBRXJCLE1BQU0scUJBQXFCLENBQUM7QUFDN0IsT0FBTyxFQUFFLGNBQWMsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7O0FBUy9FOzs7O0dBSUc7QUFFSCxNQUFNLE9BQU8sb0JBQW9CO0lBZS9CO1FBZE8sMEJBQXFCLEdBQzFCLElBQUksWUFBWSxFQUFFLENBQUM7UUFjbkIsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2QsQ0FBQztJQUVNLHlCQUF5QjtRQUM5QixJQUFJLENBQUMsSUFBSSxDQUFDLHdCQUF3QjtZQUFFLE9BQU87UUFDM0MsT0FBTyxJQUFJLENBQUMsd0JBQXdCLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDdkQsQ0FBQztJQUVNLHlCQUF5QjtRQUM5QixJQUFJLENBQUMsSUFBSSxDQUFDLHdCQUF3QjtZQUFFLE9BQU87UUFDM0MsT0FBTyxJQUFJLENBQUMsd0JBQXdCLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDdkQsQ0FBQztJQUVNLHlCQUF5QjtRQUM5QixJQUFJLENBQUMsSUFBSSxDQUFDLHdCQUF3QjtZQUFFLE9BQU87UUFDM0MsT0FBTyxJQUFJLENBQUMsd0JBQXdCLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDdkQsQ0FBQztJQUVNLEtBQUssQ0FBQyxZQUFZLENBQUMsS0FB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QUksQ0FBQyxHQUFHLENBQUMsR0FBRyxrQkFBa0IsQ0FBQyxDQUFDO1FBQzdDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxrQkFBa0IsQ0FBQyxDQUFDO1FBQzdDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxrQkFBa0IsQ0FBQyxDQUFDO1FBQzdDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxrQkFBa0IsQ0FBQyxDQUFDO1FBQzdDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksR0FBRyxJQUFJLEVBQUUsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDO0lBQ2hELENBQUM7O2lIQS9YVSxvQkFBb0I7cUhBQXBCLG9CQUFvQjsyRkFBcEIsb0JBQW9CO2tCQURoQyxVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXZlbnRFbWl0dGVyLCBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBIQU5EX0NPTk5FQ1RJT05TLFxuICBIb2xpc3RpYyxcbiAgTm9ybWFsaXplZExhbmRtYXJrLFxuICBOb3JtYWxpemVkTGFuZG1hcmtMaXN0LFxuICBQT1NFX0NPTk5FQ1RJT05TLFxuICBQT1NFX0xBTkRNQVJLUyxcbiAgUE9TRV9MQU5ETUFSS1NfTEVGVCxcbiAgUE9TRV9MQU5ETUFSS1NfUklHSFQsXG4gIFJlc3VsdHMsXG59IGZyb20gJ0BtZWRpYXBpcGUvaG9saXN0aWMnO1xuaW1wb3J0IHsgZHJhd0Nvbm5lY3RvcnMsIGRyYXdMYW5kbWFya3MsIGxlcnAgfSBmcm9tICdAbWVkaWFwaXBlL2RyYXdpbmdfdXRpbHMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIE9uUmVzdWx0c0V2ZW50IHtcbiAgbXBSZXN1bHRzOiBSZXN1bHRzO1xuICBmcmFtZUltYWdlRGF0YVVybDogc3RyaW5nO1xuICBwb3NlUHJldmlld0ltYWdlRGF0YVVybDogc3RyaW5nO1xuICBmYWNlRnJhbWVJbWFnZURhdGFVcmw/OiBzdHJpbmc7XG59XG5cbi8qKlxuICogTWVkaWFQaXBlIOOCkueUqOOBhOOBpuWLleeUu+OBi+OCieODneODvOOCuuOCkuaKveWHuuOBmeOCi+OBn+OCgeOBruOCteODvOODk+OCuVxuICpcbiAqIOKAuyDjgrfjg7PjgrDjg6vjg4jjg7PjgarjgrXjg7zjg5Pjgrnjgafjga/jgarjgYTjgZ/jgoHjgIFDb21wb25lbnQg44GnIHByb3ZpZGVycyDjgavmjIflrprjgZfjgabkvb/nlKjjgZnjgovjgZPjgajjgpLmg7PlrppcbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFBvc2VFeHRyYWN0b3JTZXJ2aWNlIHtcbiAgcHVibGljIG9uUmVzdWx0c0V2ZW50RW1pdHRlcjogRXZlbnRFbWl0dGVyPE9uUmVzdWx0c0V2ZW50PiA9XG4gICAgbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIHByaXZhdGUgaG9saXN0aWM/OiBIb2xpc3RpYztcblxuICBwcml2YXRlIHBvc2VQcmV2aWV3Q2FudmFzRWxlbWVudD86IEhUTUxDYW52YXNFbGVtZW50O1xuICBwcml2YXRlIHBvc2VQcmV2aWV3Q2FudmFzQ29udGV4dD86IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRDtcblxuICBwcml2YXRlIGhhbmRQcmV2aWV3Q2FudmFzRWxlbWVudD86IEhUTUxDYW52YXNFbGVtZW50O1xuICBwcml2YXRlIGhhbmRQcmV2aWV3Q2FudmFzQ29udGV4dD86IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRDtcblxuICBwcml2YXRlIGZhY2VQcmV2aWV3Q2FudmFzRWxlbWVudD86IEhUTUxDYW52YXNFbGVtZW50O1xuICBwcml2YXRlIGZhY2VQcmV2aWV3Q2FudmFzQ29udGV4dD86IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRDtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLmluaXQoKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRQb3NlUHJldmlld01lZGlhU3RyZWFtKCk6IE1lZGlhU3RyZWFtIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoIXRoaXMucG9zZVByZXZpZXdDYW52YXNFbGVtZW50KSByZXR1cm47XG4gICAgcmV0dXJuIHRoaXMucG9zZVByZXZpZXdDYW52YXNFbGVtZW50LmNhcHR1cmVTdHJlYW0oKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRIYW5kUHJldmlld01lZGlhU3RyZWFtKCk6IE1lZGlhU3RyZWFtIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoIXRoaXMuaGFuZFByZXZpZXdDYW52YXNFbGVtZW50KSByZXR1cm47XG4gICAgcmV0dXJuIHRoaXMuaGFuZFByZXZpZXdDYW52YXNFbGVtZW50LmNhcHR1cmVTdHJlYW0oKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRGYWNlUHJldmlld01lZGlhU3RyZWFtKCk6IE1lZGlhU3RyZWFtIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoIXRoaXMuZmFjZVByZXZpZXdDYW52YXNFbGVtZW50KSByZXR1cm47XG4gICAgcmV0dXJuIHRoaXMuZmFjZVByZXZpZXdDYW52YXNFbGVtZW50LmNhcHR1cmVTdHJlYW0oKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBvblZpZGVvRnJhbWUoaW5wdXQ6IEhUTUxWaWRlb0VsZW1lbnQgfCBIVE1MQ2FudmFzRWxlbWVudCkge1xuICAgIGlmICghdGhpcy5ob2xpc3RpYykgcmV0dXJuO1xuXG4gICAgaWYgKGlucHV0IGluc3RhbmNlb2YgSFRNTFZpZGVvRWxlbWVudCkge1xuICAgICAgaWYgKHRoaXMucG9zZVByZXZpZXdDYW52YXNFbGVtZW50KSB7XG4gICAgICAgIHRoaXMucG9zZVByZXZpZXdDYW52YXNFbGVtZW50LndpZHRoID0gaW5wdXQudmlkZW9XaWR0aDtcbiAgICAgICAgdGhpcy5wb3NlUHJldmlld0NhbnZhc0VsZW1lbnQuaGVpZ2h0ID0gaW5wdXQudmlkZW9IZWlnaHQ7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLmhhbmRQcmV2aWV3Q2FudmFzRWxlbWVudCkge1xuICAgICAgICB0aGlzLmhhbmRQcmV2aWV3Q2FudmFzRWxlbWVudC53aWR0aCA9IGlucHV0LnZpZGVvV2lkdGg7XG4gICAgICAgIHRoaXMuaGFuZFByZXZpZXdDYW52YXNFbGVtZW50LmhlaWdodCA9IGlucHV0LnZpZGVvSGVpZ2h0O1xuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5mYWNlUHJldmlld0NhbnZhc0VsZW1lbnQpIHtcbiAgICAgICAgdGhpcy5mYWNlUHJldmlld0NhbnZhc0VsZW1lbnQud2lkdGggPSBpbnB1dC52aWRlb1dpZHRoO1xuICAgICAgICB0aGlzLmZhY2VQcmV2aWV3Q2FudmFzRWxlbWVudC5oZWlnaHQgPSBpbnB1dC52aWRlb0hlaWdodDtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGlucHV0IGluc3RhbmNlb2YgSFRNTENhbnZhc0VsZW1lbnQpIHtcbiAgICAgIGlmICh0aGlzLnBvc2VQcmV2aWV3Q2FudmFzRWxlbWVudCkge1xuICAgICAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzRWxlbWVudC53aWR0aCA9IGlucHV0LndpZHRoO1xuICAgICAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzRWxlbWVudC5oZWlnaHQgPSBpbnB1dC5oZWlnaHQ7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLmhhbmRQcmV2aWV3Q2FudmFzRWxlbWVudCkge1xuICAgICAgICB0aGlzLmhhbmRQcmV2aWV3Q2FudmFzRWxlbWVudC53aWR0aCA9IGlucHV0LndpZHRoO1xuICAgICAgICB0aGlzLmhhbmRQcmV2aWV3Q2FudmFzRWxlbWVudC5oZWlnaHQgPSBpbnB1dC5oZWlnaHQ7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLmZhY2VQcmV2aWV3Q2FudmFzRWxlbWVudCkge1xuICAgICAgICB0aGlzLmZhY2VQcmV2aWV3Q2FudmFzRWxlbWVudC53aWR0aCA9IGlucHV0LndpZHRoO1xuICAgICAgICB0aGlzLmZhY2VQcmV2aWV3Q2FudmFzRWxlbWVudC5oZWlnaHQgPSBpbnB1dC5oZWlnaHQ7XG4gICAgICB9XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5ob2xpc3RpYy5zZW5kKHsgaW1hZ2U6IGlucHV0IH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0KCkge1xuICAgIHRoaXMucG9zZVByZXZpZXdDYW52YXNFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7XG4gICAgdGhpcy5wb3NlUHJldmlld0NhbnZhc0NvbnRleHQgPVxuICAgICAgdGhpcy5wb3NlUHJldmlld0NhbnZhc0VsZW1lbnQuZ2V0Q29udGV4dCgnMmQnKSB8fCB1bmRlZmluZWQ7XG5cbiAgICB0aGlzLmhhbmRQcmV2aWV3Q2FudmFzRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xuICAgIHRoaXMuaGFuZFByZXZpZXdDYW52YXNDb250ZXh0ID1cbiAgICAgIHRoaXMuaGFuZFByZXZpZXdDYW52YXNFbGVtZW50LmdldENvbnRleHQoJzJkJykgfHwgdW5kZWZpbmVkO1xuXG4gICAgdGhpcy5mYWNlUHJldmlld0NhbnZhc0VsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcbiAgICB0aGlzLmZhY2VQcmV2aWV3Q2FudmFzQ29udGV4dCA9XG4gICAgICB0aGlzLmZhY2VQcmV2aWV3Q2FudmFzRWxlbWVudC5nZXRDb250ZXh0KCcyZCcpIHx8IHVuZGVmaW5lZDtcblxuICAgIHRoaXMuaG9saXN0aWMgPSBuZXcgSG9saXN0aWMoe1xuICAgICAgbG9jYXRlRmlsZTogKGZpbGUpID0+IHtcbiAgICAgICAgcmV0dXJuIGBodHRwczovL2Nkbi5qc2RlbGl2ci5uZXQvbnBtL0BtZWRpYXBpcGUvaG9saXN0aWMvJHtmaWxlfWA7XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgdGhpcy5ob2xpc3RpYy5zZXRPcHRpb25zKHtcbiAgICAgIHNlbGZpZU1vZGU6IGZhbHNlLFxuICAgICAgbW9kZWxDb21wbGV4aXR5OiAxLFxuICAgICAgc21vb3RoTGFuZG1hcmtzOiB0cnVlLFxuICAgICAgZW5hYmxlU2VnbWVudGF0aW9uOiBmYWxzZSxcbiAgICAgIHNtb290aFNlZ21lbnRhdGlvbjogdHJ1ZSxcbiAgICAgIG1pbkRldGVjdGlvbkNvbmZpZGVuY2U6IDAuNixcbiAgICAgIG1pblRyYWNraW5nQ29uZmlkZW5jZTogMC42LFxuICAgIH0pO1xuXG4gICAgdGhpcy5ob2xpc3RpYy5vblJlc3VsdHMoKHJlc3VsdHM6IFJlc3VsdHMpID0+IHtcbiAgICAgIHRoaXMub25SZXN1bHRzKHJlc3VsdHMpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBvblJlc3VsdHMocmVzdWx0czogUmVzdWx0cykge1xuICAgIGlmIChcbiAgICAgICF0aGlzLnBvc2VQcmV2aWV3Q2FudmFzRWxlbWVudCB8fFxuICAgICAgIXRoaXMucG9zZVByZXZpZXdDYW52YXNDb250ZXh0IHx8XG4gICAgICAhdGhpcy5ob2xpc3RpY1xuICAgIClcbiAgICAgIHJldHVybjtcblxuICAgIC8vIOaPj+eUu+eUqOOBq+S4jeW/heimgeOBquODqeODs+ODieODnuODvOOCr+OCkumZpOWOu1xuICAgIGxldCBwb3NlTGFuZG1hcmtzOiBOb3JtYWxpemVkTGFuZG1hcmtMaXN0ID0gW107XG4gICAgaWYgKHJlc3VsdHMucG9zZUxhbmRtYXJrcykge1xuICAgICAgcG9zZUxhbmRtYXJrcyA9IEpTT04ucGFyc2UoXG4gICAgICAgIEpTT04uc3RyaW5naWZ5KHJlc3VsdHMucG9zZUxhbmRtYXJrcylcbiAgICAgICkgYXMgTm9ybWFsaXplZExhbmRtYXJrTGlzdDtcbiAgICAgIHRoaXMucmVtb3ZlRWxlbWVudHMoXG4gICAgICAgIHBvc2VMYW5kbWFya3MsXG4gICAgICAgIFswLCAxLCAyLCAzLCA0LCA1LCA2LCA3LCA4LCA5LCAxMCwgMTUsIDE2LCAxNywgMTgsIDE5LCAyMCwgMjEsIDIyXVxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyDjgq3jg6Pjg7Pjg5DjgrnjgpLloZfjgorjgaTjgbbjgZdcbiAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzQ29udGV4dC5zYXZlKCk7XG4gICAgdGhpcy5wb3NlUHJldmlld0NhbnZhc0NvbnRleHQuY2xlYXJSZWN0KFxuICAgICAgMCxcbiAgICAgIDAsXG4gICAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzRWxlbWVudC53aWR0aCxcbiAgICAgIHRoaXMucG9zZVByZXZpZXdDYW52YXNFbGVtZW50LmhlaWdodFxuICAgICk7XG5cbiAgICAvLyDmpJzlh7rjgavkvb/nlKjjgZfjgZ/jg5Xjg6zjg7zjg6DnlLvlg4/jgpLmj4/nlLtcbiAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzQ29udGV4dC5kcmF3SW1hZ2UoXG4gICAgICByZXN1bHRzLmltYWdlLFxuICAgICAgMCxcbiAgICAgIDAsXG4gICAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzRWxlbWVudC53aWR0aCxcbiAgICAgIHRoaXMucG9zZVByZXZpZXdDYW52YXNFbGVtZW50LmhlaWdodFxuICAgICk7XG5cbiAgICAvLyDmpJzlh7rjgavkvb/nlKjjgZfjgZ/jg5Xjg6zjg7zjg6DnlLvlg4/jgpLkv53mjIEgKOWKoOW3peOBleOCjOOBpuOBhOOBquOBhOeUu+WDjylcbiAgICBjb25zdCBzb3VyY2VJbWFnZURhdGFVcmwgPVxuICAgICAgdGhpcy5wb3NlUHJldmlld0NhbnZhc0VsZW1lbnQudG9EYXRhVVJMKCdpbWFnZS9wbmcnKTtcblxuICAgIC8vIOiCmOOBqOaJi+OCkuOBpOOBquOBkOe3muOCkuaPj+eUu1xuICAgIHRoaXMucG9zZVByZXZpZXdDYW52YXNDb250ZXh0LmxpbmVXaWR0aCA9IDU7XG4gICAgaWYgKHBvc2VMYW5kbWFya3MpIHtcbiAgICAgIGlmIChyZXN1bHRzLnJpZ2h0SGFuZExhbmRtYXJrcykge1xuICAgICAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzQ29udGV4dC5zdHJva2VTdHlsZSA9ICd3aGl0ZSc7XG4gICAgICAgIHRoaXMuY29ubmVjdCh0aGlzLnBvc2VQcmV2aWV3Q2FudmFzQ29udGV4dCwgW1xuICAgICAgICAgIFtcbiAgICAgICAgICAgIHBvc2VMYW5kbWFya3NbUE9TRV9MQU5ETUFSS1MuUklHSFRfRUxCT1ddLFxuICAgICAgICAgICAgcmVzdWx0cy5yaWdodEhhbmRMYW5kbWFya3NbMF0sXG4gICAgICAgICAgXSxcbiAgICAgICAgXSk7XG4gICAgICB9XG4gICAgICBpZiAocmVzdWx0cy5sZWZ0SGFuZExhbmRtYXJrcykge1xuICAgICAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzQ29udGV4dC5zdHJva2VTdHlsZSA9ICd3aGl0ZSc7XG4gICAgICAgIHRoaXMuY29ubmVjdCh0aGlzLnBvc2VQcmV2aWV3Q2FudmFzQ29udGV4dCwgW1xuICAgICAgICAgIFtcbiAgICAgICAgICAgIHBvc2VMYW5kbWFya3NbUE9TRV9MQU5ETUFSS1MuTEVGVF9FTEJPV10sXG4gICAgICAgICAgICByZXN1bHRzLmxlZnRIYW5kTGFuZG1hcmtzWzBdLFxuICAgICAgICAgIF0sXG4gICAgICAgIF0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIOODneODvOOCuuOBruODl+ODrOODk+ODpeODvOOCkuaPj+eUu1xuICAgIGlmIChwb3NlTGFuZG1hcmtzKSB7XG4gICAgICBkcmF3Q29ubmVjdG9ycyhcbiAgICAgICAgdGhpcy5wb3NlUHJldmlld0NhbnZhc0NvbnRleHQsXG4gICAgICAgIHBvc2VMYW5kbWFya3MsXG4gICAgICAgIFBPU0VfQ09OTkVDVElPTlMsXG4gICAgICAgIHsgY29sb3I6ICd3aGl0ZScgfVxuICAgICAgKTtcbiAgICAgIGRyYXdMYW5kbWFya3MoXG4gICAgICAgIHRoaXMucG9zZVByZXZpZXdDYW52YXNDb250ZXh0LFxuICAgICAgICBPYmplY3QudmFsdWVzKFBPU0VfTEFORE1BUktTX0xFRlQpLm1hcCgoaW5kZXgpID0+IHBvc2VMYW5kbWFya3NbaW5kZXhdKSxcbiAgICAgICAgeyB2aXNpYmlsaXR5TWluOiAwLjY1LCBjb2xvcjogJ3doaXRlJywgZmlsbENvbG9yOiAncmdiKDI1NSwxMzgsMCknIH1cbiAgICAgICk7XG4gICAgICBkcmF3TGFuZG1hcmtzKFxuICAgICAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzQ29udGV4dCxcbiAgICAgICAgT2JqZWN0LnZhbHVlcyhQT1NFX0xBTkRNQVJLU19SSUdIVCkubWFwKFxuICAgICAgICAgIChpbmRleCkgPT4gcG9zZUxhbmRtYXJrc1tpbmRleF1cbiAgICAgICAgKSxcbiAgICAgICAgeyB2aXNpYmlsaXR5TWluOiAwLjY1LCBjb2xvcjogJ3doaXRlJywgZmlsbENvbG9yOiAncmdiKDAsMjE3LDIzMSknIH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8g5omL44Gu44OX44Os44OT44Ol44O844KS5o+P55S7XG4gICAgZHJhd0Nvbm5lY3RvcnMoXG4gICAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzQ29udGV4dCxcbiAgICAgIHJlc3VsdHMucmlnaHRIYW5kTGFuZG1hcmtzLFxuICAgICAgSEFORF9DT05ORUNUSU9OUyxcbiAgICAgIHsgY29sb3I6ICd3aGl0ZScgfVxuICAgICk7XG4gICAgZHJhd0xhbmRtYXJrcyh0aGlzLnBvc2VQcmV2aWV3Q2FudmFzQ29udGV4dCwgcmVzdWx0cy5yaWdodEhhbmRMYW5kbWFya3MsIHtcbiAgICAgIGNvbG9yOiAnd2hpdGUnLFxuICAgICAgZmlsbENvbG9yOiAncmdiKDAsMjE3LDIzMSknLFxuICAgICAgbGluZVdpZHRoOiAyLFxuICAgICAgcmFkaXVzOiAoZGF0YTogYW55KSA9PiB7XG4gICAgICAgIHJldHVybiBsZXJwKGRhdGEuZnJvbS56LCAtMC4xNSwgMC4xLCAxMCwgMSk7XG4gICAgICB9LFxuICAgIH0pO1xuICAgIGRyYXdDb25uZWN0b3JzKFxuICAgICAgdGhpcy5wb3NlUHJldmlld0NhbnZhc0NvbnRleHQsXG4gICAgICByZXN1bHRzLmxlZnRIYW5kTGFuZG1hcmtzLFxuICAgICAgSEFORF9DT05ORUNUSU9OUyxcbiAgICAgIHsgY29sb3I6ICd3aGl0ZScgfVxuICAgICk7XG4gICAgZHJhd0xhbmRtYXJrcyh0aGlzLnBvc2VQcmV2aWV3Q2FudmFzQ29udGV4dCwgcmVzdWx0cy5sZWZ0SGFuZExhbmRtYXJrcywge1xuICAgICAgY29sb3I6ICd3aGl0ZScsXG4gICAgICBmaWxsQ29sb3I6ICdyZ2IoMjU1LDEzOCwwKScsXG4gICAgICBsaW5lV2lkdGg6IDIsXG4gICAgICByYWRpdXM6IChkYXRhOiBhbnkpID0+IHtcbiAgICAgICAgcmV0dXJuIGxlcnAoZGF0YS5mcm9tLnosIC0wLjE1LCAwLjEsIDEwLCAxKTtcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyDmiYvjga7poJjln5/jga7jgb/jga7jg5fjg6zjg5Pjg6Xjg7znlLvlg4/jgpLnlJ/miJBcbiAgICBpZiAodGhpcy5oYW5kUHJldmlld0NhbnZhc0NvbnRleHQgJiYgdGhpcy5oYW5kUHJldmlld0NhbnZhc0VsZW1lbnQpIHtcbiAgICAgIGNvbnN0IEhBTkRfUFJFVklFV19aT09NID0gMztcbiAgICAgIGNvbnN0IGhhbmRQcmV2aWV3QmFzZVkgPSB0aGlzLmhhbmRQcmV2aWV3Q2FudmFzRWxlbWVudC5oZWlnaHQgLyAyO1xuXG4gICAgICB0aGlzLmhhbmRQcmV2aWV3Q2FudmFzQ29udGV4dC5jbGVhclJlY3QoXG4gICAgICAgIDAsXG4gICAgICAgIDAsXG4gICAgICAgIHRoaXMuaGFuZFByZXZpZXdDYW52YXNFbGVtZW50LndpZHRoLFxuICAgICAgICB0aGlzLmhhbmRQcmV2aWV3Q2FudmFzRWxlbWVudC5oZWlnaHRcbiAgICAgICk7XG5cbiAgICAgIGlmIChyZXN1bHRzLnJpZ2h0SGFuZExhbmRtYXJrcykge1xuICAgICAgICBjb25zdCByZWN0ID0gdGhpcy5nZXRSZWN0QnlMYW5kbWFya3MoXG4gICAgICAgICAgcmVzdWx0cy5yaWdodEhhbmRMYW5kbWFya3MsXG4gICAgICAgICAgcmVzdWx0cy5pbWFnZS53aWR0aCxcbiAgICAgICAgICByZXN1bHRzLmltYWdlLmhlaWdodFxuICAgICAgICApO1xuXG4gICAgICAgIGxldCBoYW5kUHJldmlld1ggPSAwO1xuICAgICAgICBsZXQgaGFuZFByZXZpZXdZID0gaGFuZFByZXZpZXdCYXNlWSAtIChyZWN0WzNdICogSEFORF9QUkVWSUVXX1pPT00pIC8gMjtcblxuICAgICAgICB0aGlzLmhhbmRQcmV2aWV3Q2FudmFzQ29udGV4dC5kcmF3SW1hZ2UoXG4gICAgICAgICAgdGhpcy5wb3NlUHJldmlld0NhbnZhc0VsZW1lbnQsXG4gICAgICAgICAgcmVjdFswXSAtIDEwLFxuICAgICAgICAgIHJlY3RbMV0gLSAxMCxcbiAgICAgICAgICByZWN0WzJdICsgMTAsXG4gICAgICAgICAgcmVjdFszXSArIDEwLFxuICAgICAgICAgIGhhbmRQcmV2aWV3WCxcbiAgICAgICAgICBoYW5kUHJldmlld1ksXG4gICAgICAgICAgcmVjdFsyXSAqIEhBTkRfUFJFVklFV19aT09NLFxuICAgICAgICAgIHJlY3RbM10gKiBIQU5EX1BSRVZJRVdfWk9PTVxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBpZiAocmVzdWx0cy5sZWZ0SGFuZExhbmRtYXJrcykge1xuICAgICAgICBjb25zdCByZWN0ID0gdGhpcy5nZXRSZWN0QnlMYW5kbWFya3MoXG4gICAgICAgICAgcmVzdWx0cy5sZWZ0SGFuZExhbmRtYXJrcyxcbiAgICAgICAgICByZXN1bHRzLmltYWdlLndpZHRoLFxuICAgICAgICAgIHJlc3VsdHMuaW1hZ2UuaGVpZ2h0XG4gICAgICAgICk7XG5cbiAgICAgICAgbGV0IGhhbmRQcmV2aWV3WCA9XG4gICAgICAgICAgdGhpcy5oYW5kUHJldmlld0NhbnZhc0VsZW1lbnQud2lkdGggLSByZWN0WzJdICogSEFORF9QUkVWSUVXX1pPT007XG4gICAgICAgIGxldCBoYW5kUHJldmlld1kgPSBoYW5kUHJldmlld0Jhc2VZIC0gKHJlY3RbM10gKiBIQU5EX1BSRVZJRVdfWk9PTSkgLyAyO1xuXG4gICAgICAgIHRoaXMuaGFuZFByZXZpZXdDYW52YXNDb250ZXh0LmRyYXdJbWFnZShcbiAgICAgICAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzRWxlbWVudCxcbiAgICAgICAgICByZWN0WzBdIC0gMTAsXG4gICAgICAgICAgcmVjdFsxXSAtIDEwLFxuICAgICAgICAgIHJlY3RbMl0gKyAxMCxcbiAgICAgICAgICByZWN0WzNdICsgMTAsXG4gICAgICAgICAgaGFuZFByZXZpZXdYLFxuICAgICAgICAgIGhhbmRQcmV2aWV3WSxcbiAgICAgICAgICByZWN0WzJdICogSEFORF9QUkVWSUVXX1pPT00sXG4gICAgICAgICAgcmVjdFszXSAqIEhBTkRfUFJFVklFV19aT09NXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8g6aGU44Gu6aCY5Z+f44Gu44G/44Gu44OV44Os44O844Og55S75YOP44KS55Sf5oiQXG4gICAgaWYgKHRoaXMuZmFjZVByZXZpZXdDYW52YXNDb250ZXh0ICYmIHRoaXMuZmFjZVByZXZpZXdDYW52YXNFbGVtZW50KSB7XG4gICAgICBjb25zdCBGQUNFX1BSRVZJRVdfWk9PTSA9IDEuMjU7XG4gICAgICBjb25zdCBmYWNlUHJldmlld0Jhc2VZID0gdGhpcy5mYWNlUHJldmlld0NhbnZhc0VsZW1lbnQuaGVpZ2h0IC8gMjtcblxuICAgICAgaWYgKHJlc3VsdHMuZmFjZUxhbmRtYXJrcykge1xuICAgICAgICBjb25zdCByZWN0ID0gdGhpcy5nZXRSZWN0QnlMYW5kbWFya3MoXG4gICAgICAgICAgcmVzdWx0cy5mYWNlTGFuZG1hcmtzLFxuICAgICAgICAgIHJlc3VsdHMuaW1hZ2Uud2lkdGgsXG4gICAgICAgICAgcmVzdWx0cy5pbWFnZS5oZWlnaHRcbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCByZWN0V2lkdGggPSByZWN0WzJdICogRkFDRV9QUkVWSUVXX1pPT007XG4gICAgICAgIGNvbnN0IHJlY3RIZWlnaHQgPSByZWN0WzNdICogRkFDRV9QUkVWSUVXX1pPT007XG5cbiAgICAgICAgdGhpcy5mYWNlUHJldmlld0NhbnZhc0VsZW1lbnQud2lkdGggPSByZWN0V2lkdGg7XG4gICAgICAgIHRoaXMuZmFjZVByZXZpZXdDYW52YXNFbGVtZW50LmhlaWdodCA9IHJlY3RIZWlnaHQ7XG5cbiAgICAgICAgdGhpcy5mYWNlUHJldmlld0NhbnZhc0NvbnRleHQuY2xlYXJSZWN0KDAsIDAsIHJlY3RXaWR0aCwgcmVjdEhlaWdodCk7XG5cbiAgICAgICAgdGhpcy5mYWNlUHJldmlld0NhbnZhc0NvbnRleHQuZHJhd0ltYWdlKFxuICAgICAgICAgIHJlc3VsdHMuaW1hZ2UsXG4gICAgICAgICAgcmVjdFswXSAtIDEwLFxuICAgICAgICAgIHJlY3RbMV0gLSAxMCxcbiAgICAgICAgICByZWN0WzJdICsgMTAsXG4gICAgICAgICAgcmVjdFszXSArIDEwLFxuICAgICAgICAgIDAsXG4gICAgICAgICAgMCxcbiAgICAgICAgICByZWN0V2lkdGgsXG4gICAgICAgICAgcmVjdEhlaWdodFxuICAgICAgICApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5mYWNlUHJldmlld0NhbnZhc0NvbnRleHQuY2xlYXJSZWN0KFxuICAgICAgICAgIDAsXG4gICAgICAgICAgMCxcbiAgICAgICAgICB0aGlzLmZhY2VQcmV2aWV3Q2FudmFzRWxlbWVudC53aWR0aCxcbiAgICAgICAgICB0aGlzLmZhY2VQcmV2aWV3Q2FudmFzRWxlbWVudC5oZWlnaHRcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyDjgqTjg5njg7Pjg4jjgpLpgIHlh7pcbiAgICB0aGlzLm9uUmVzdWx0c0V2ZW50RW1pdHRlci5lbWl0KHtcbiAgICAgIG1wUmVzdWx0czogcmVzdWx0cyxcbiAgICAgIC8vIOWKoOW3peOBleOCjOOBpuOBhOOBquOBhOeUu+WDjyAoUE5HKVxuICAgICAgZnJhbWVJbWFnZURhdGFVcmw6IHNvdXJjZUltYWdlRGF0YVVybCxcbiAgICAgIC8vIOWKoOW3peOBleOCjOOBn+eUu+WDjyAoUE5HKVxuICAgICAgcG9zZVByZXZpZXdJbWFnZURhdGFVcmw6XG4gICAgICAgIHRoaXMucG9zZVByZXZpZXdDYW52YXNFbGVtZW50LnRvRGF0YVVSTCgnaW1hZ2UvcG5nJyksXG4gICAgICAvLyDpoZTjga7jgb/jga7nlLvlg48gKFBORylcbiAgICAgIGZhY2VGcmFtZUltYWdlRGF0YVVybDogcmVzdWx0cy5mYWNlTGFuZG1hcmtzXG4gICAgICAgID8gdGhpcy5mYWNlUHJldmlld0NhbnZhc0VsZW1lbnQhLnRvRGF0YVVSTCgnaW1hZ2UvcG5nJylcbiAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgfSk7XG5cbiAgICAvLyDlrozkuoZcbiAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzQ29udGV4dC5yZXN0b3JlKCk7XG4gIH1cblxuICBwcml2YXRlIGNvbm5lY3QoXG4gICAgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQsXG4gICAgY29ubmVjdG9yczogQXJyYXk8W05vcm1hbGl6ZWRMYW5kbWFyaywgTm9ybWFsaXplZExhbmRtYXJrXT5cbiAgKSB7XG4gICAgY29uc3QgY2FudmFzID0gY3R4LmNhbnZhcztcbiAgICBmb3IgKGNvbnN0IGNvbm5lY3RvciBvZiBjb25uZWN0b3JzKSB7XG4gICAgICBjb25zdCBmcm9tID0gY29ubmVjdG9yWzBdO1xuICAgICAgY29uc3QgdG8gPSBjb25uZWN0b3JbMV07XG4gICAgICBpZiAoZnJvbSAmJiB0bykge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgZnJvbS52aXNpYmlsaXR5ICYmXG4gICAgICAgICAgdG8udmlzaWJpbGl0eSAmJlxuICAgICAgICAgIChmcm9tLnZpc2liaWxpdHkgPCAwLjEgfHwgdG8udmlzaWJpbGl0eSA8IDAuMSlcbiAgICAgICAgKSB7XG4gICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgY3R4LmJlZ2luUGF0aCgpO1xuICAgICAgICBjdHgubW92ZVRvKGZyb20ueCAqIGNhbnZhcy53aWR0aCwgZnJvbS55ICogY2FudmFzLmhlaWdodCk7XG4gICAgICAgIGN0eC5saW5lVG8odG8ueCAqIGNhbnZhcy53aWR0aCwgdG8ueSAqIGNhbnZhcy5oZWlnaHQpO1xuICAgICAgICBjdHguc3Ryb2tlKCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVFbGVtZW50cyhcbiAgICBsYW5kbWFya3M6IE5vcm1hbGl6ZWRMYW5kbWFya0xpc3QsXG4gICAgZWxlbWVudHM6IG51bWJlcltdXG4gICkge1xuICAgIGZvciAoY29uc3QgZWxlbWVudCBvZiBlbGVtZW50cykge1xuICAgICAgZGVsZXRlIGxhbmRtYXJrc1tlbGVtZW50XTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldFJlY3RCeUxhbmRtYXJrcyhsYW5kbWFya3M6IGFueVtdLCB3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlcikge1xuICAgIGNvbnN0IGxlZnRIYW5kTGFuZG1hcmtzWCA9IGxhbmRtYXJrcy5tYXAoKGxhbmRtYXJrKSA9PiBsYW5kbWFyay54ICogd2lkdGgpO1xuICAgIGNvbnN0IGxlZnRIYW5kTGFuZG1hcmtzWSA9IGxhbmRtYXJrcy5tYXAoKGxhbmRtYXJrKSA9PiBsYW5kbWFyay55ICogaGVpZ2h0KTtcbiAgICBjb25zdCBtaW5YID0gTWF0aC5taW4oLi4ubGVmdEhhbmRMYW5kbWFya3NYKTtcbiAgICBjb25zdCBtYXhYID0gTWF0aC5tYXgoLi4ubGVmdEhhbmRMYW5kbWFya3NYKTtcbiAgICBjb25zdCBtaW5ZID0gTWF0aC5taW4oLi4ubGVmdEhhbmRMYW5kbWFya3NZKTtcbiAgICBjb25zdCBtYXhZID0gTWF0aC5tYXgoLi4ubGVmdEhhbmRMYW5kbWFya3NZKTtcbiAgICByZXR1cm4gW21pblgsIG1pblksIG1heFggLSBtaW5YLCBtYXhZIC0gbWluWV07XG4gIH1cbn1cbiJdfQ==