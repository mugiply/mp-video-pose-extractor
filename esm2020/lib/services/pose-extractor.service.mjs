import { EventEmitter, Injectable } from '@angular/core';
import { HAND_CONNECTIONS, Holistic, POSE_CONNECTIONS, POSE_LANDMARKS, POSE_LANDMARKS_LEFT, POSE_LANDMARKS_RIGHT, } from '@mediapipe/holistic';
import { drawConnectors, drawLandmarks, lerp } from '@mediapipe/drawing_utils';
import * as i0 from "@angular/core";
/**
 * MediaPipe を用いて動画からポーズを抽出するためのサービス
 *
 * ※ シングルトンなサービスではないため、Component で providers に指定して使用することを想定
 */
export class PoseExtractorService {
    constructor() {
        this.onResultsEventEmitter = new EventEmitter();
        this.IMAGE_JPEG_QUALITY = 0.8;
        this.init();
    }
    getPosePreviewMediaStream() {
        if (!this.posePreviewCanvasElement)
            return;
        return this.posePreviewCanvasElement.captureStream();
    }
    getHandPreviewMediaStream() {
        if (!this.handPreviewCanvasElement)
            return;
        return this.handPreviewCanvasElement.captureStream();
    }
    async onVideoFrame(videoElement) {
        if (!this.holistic)
            return;
        if (this.posePreviewCanvasElement) {
            this.posePreviewCanvasElement.width = videoElement.videoWidth;
            this.posePreviewCanvasElement.height = videoElement.videoHeight;
        }
        if (this.handPreviewCanvasElement) {
            this.handPreviewCanvasElement.width = videoElement.videoWidth;
            this.handPreviewCanvasElement.height = videoElement.videoHeight;
        }
        await this.holistic.send({ image: videoElement });
    }
    init() {
        this.posePreviewCanvasElement = document.createElement('canvas');
        this.posePreviewCanvasContext =
            this.posePreviewCanvasElement.getContext('2d') || undefined;
        this.handPreviewCanvasElement = document.createElement('canvas');
        this.handPreviewCanvasContext =
            this.handPreviewCanvasElement.getContext('2d') || undefined;
        this.holistic = new Holistic({
            locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`;
            },
        });
        this.holistic.setOptions({
            selfieMode: false,
            modelComplexity: 1,
            smoothLandmarks: true,
            enableSegmentation: false,
            smoothSegmentation: true,
            minDetectionConfidence: 0.6,
            minTrackingConfidence: 0.6,
        });
        this.holistic.onResults((results) => {
            this.onResults(results);
        });
    }
    onResults(results) {
        if (!this.posePreviewCanvasElement ||
            !this.posePreviewCanvasContext ||
            !this.holistic)
            return;
        // 描画用に不必要なランドマークを除去
        let poseLandmarks = [];
        if (results.poseLandmarks) {
            poseLandmarks = JSON.parse(JSON.stringify(results.poseLandmarks));
            this.removeElements(poseLandmarks, [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 15, 16, 17, 18, 19, 20, 21, 22]);
        }
        // キャンバスを塗りつぶし
        this.posePreviewCanvasContext.save();
        this.posePreviewCanvasContext.clearRect(0, 0, this.posePreviewCanvasElement.width, this.posePreviewCanvasElement.height);
        // 検出に使用したフレーム画像を描画
        this.posePreviewCanvasContext.drawImage(results.image, 0, 0, this.posePreviewCanvasElement.width, this.posePreviewCanvasElement.height);
        // 検出に使用したフレーム画像を保持
        const sourceImageDataUrl = this.posePreviewCanvasElement.toDataURL('image/jpeg', this.IMAGE_JPEG_QUALITY);
        // 肘と手をつなぐ線を描画
        this.posePreviewCanvasContext.lineWidth = 5;
        if (poseLandmarks) {
            if (results.rightHandLandmarks) {
                this.posePreviewCanvasContext.strokeStyle = 'white';
                this.connect(this.posePreviewCanvasContext, [
                    [
                        poseLandmarks[POSE_LANDMARKS.RIGHT_ELBOW],
                        results.rightHandLandmarks[0],
                    ],
                ]);
            }
            if (results.leftHandLandmarks) {
                this.posePreviewCanvasContext.strokeStyle = 'white';
                this.connect(this.posePreviewCanvasContext, [
                    [
                        poseLandmarks[POSE_LANDMARKS.LEFT_ELBOW],
                        results.leftHandLandmarks[0],
                    ],
                ]);
            }
        }
        // ポーズのプレビューを描画
        if (poseLandmarks) {
            drawConnectors(this.posePreviewCanvasContext, poseLandmarks, POSE_CONNECTIONS, { color: 'white' });
            drawLandmarks(this.posePreviewCanvasContext, Object.values(POSE_LANDMARKS_LEFT).map((index) => poseLandmarks[index]), { visibilityMin: 0.65, color: 'white', fillColor: 'rgb(255,138,0)' });
            drawLandmarks(this.posePreviewCanvasContext, Object.values(POSE_LANDMARKS_RIGHT).map((index) => poseLandmarks[index]), { visibilityMin: 0.65, color: 'white', fillColor: 'rgb(0,217,231)' });
        }
        // 手のプレビューを描画
        drawConnectors(this.posePreviewCanvasContext, results.rightHandLandmarks, HAND_CONNECTIONS, { color: 'white' });
        drawLandmarks(this.posePreviewCanvasContext, results.rightHandLandmarks, {
            color: 'white',
            fillColor: 'rgb(0,217,231)',
            lineWidth: 2,
            radius: (data) => {
                return lerp(data.from.z, -0.15, 0.1, 10, 1);
            },
        });
        drawConnectors(this.posePreviewCanvasContext, results.leftHandLandmarks, HAND_CONNECTIONS, { color: 'white' });
        drawLandmarks(this.posePreviewCanvasContext, results.leftHandLandmarks, {
            color: 'white',
            fillColor: 'rgb(255,138,0)',
            lineWidth: 2,
            radius: (data) => {
                return lerp(data.from.z, -0.15, 0.1, 10, 1);
            },
        });
        // 手の領域のみのプレビューを生成
        if (this.handPreviewCanvasContext && this.handPreviewCanvasElement) {
            const HAND_PREVIEW_ZOOM = 3;
            const handPreviewBaseY = this.handPreviewCanvasElement.height / 2;
            this.handPreviewCanvasContext.clearRect(0, 0, this.handPreviewCanvasElement.width, this.handPreviewCanvasElement.height);
            if (results.rightHandLandmarks) {
                const rect = this.getRectByLandmarks(results.rightHandLandmarks, results.image.width, results.image.height);
                let handPreviewX = 0;
                let handPreviewY = handPreviewBaseY - (rect[3] * HAND_PREVIEW_ZOOM) / 2;
                this.handPreviewCanvasContext.drawImage(this.posePreviewCanvasElement, rect[0] - 10, rect[1] - 10, rect[2] + 10, rect[3] + 10, handPreviewX, handPreviewY, rect[2] * HAND_PREVIEW_ZOOM, rect[3] * HAND_PREVIEW_ZOOM);
            }
            if (results.leftHandLandmarks) {
                const rect = this.getRectByLandmarks(results.leftHandLandmarks, results.image.width, results.image.height);
                let handPreviewX = this.handPreviewCanvasElement.width - rect[2] * HAND_PREVIEW_ZOOM;
                let handPreviewY = handPreviewBaseY - (rect[3] * HAND_PREVIEW_ZOOM) / 2;
                this.handPreviewCanvasContext.drawImage(this.posePreviewCanvasElement, rect[0] - 10, rect[1] - 10, rect[2] + 10, rect[3] + 10, handPreviewX, handPreviewY, rect[2] * HAND_PREVIEW_ZOOM, rect[3] * HAND_PREVIEW_ZOOM);
            }
        }
        // イベントを送出
        this.onResultsEventEmitter.emit({
            mpResults: results,
            sourceImageDataUrl: sourceImageDataUrl,
            posePreviewImageDataUrl: this.posePreviewCanvasElement.toDataURL('image/jpeg', this.IMAGE_JPEG_QUALITY),
        });
        // 完了
        this.posePreviewCanvasContext.restore();
    }
    connect(ctx, connectors) {
        const canvas = ctx.canvas;
        for (const connector of connectors) {
            const from = connector[0];
            const to = connector[1];
            if (from && to) {
                if (from.visibility &&
                    to.visibility &&
                    (from.visibility < 0.1 || to.visibility < 0.1)) {
                    continue;
                }
                ctx.beginPath();
                ctx.moveTo(from.x * canvas.width, from.y * canvas.height);
                ctx.lineTo(to.x * canvas.width, to.y * canvas.height);
                ctx.stroke();
            }
        }
    }
    removeElements(landmarks, elements) {
        for (const element of elements) {
            delete landmarks[element];
        }
    }
    getRectByLandmarks(landmarks, width, height) {
        const leftHandLandmarksX = landmarks.map((landmark) => landmark.x * width);
        const leftHandLandmarksY = landmarks.map((landmark) => landmark.y * height);
        const minX = Math.min(...leftHandLandmarksX);
        const maxX = Math.max(...leftHandLandmarksX);
        const minY = Math.min(...leftHandLandmarksY);
        const maxY = Math.max(...leftHandLandmarksY);
        return [minX, minY, maxX - minX, maxY - minY];
    }
}
PoseExtractorService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.0.4", ngImport: i0, type: PoseExtractorService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
PoseExtractorService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.0.4", ngImport: i0, type: PoseExtractorService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.0.4", ngImport: i0, type: PoseExtractorService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return []; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9zZS1leHRyYWN0b3Iuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1tcC1wb3NlLWV4dHJhY3Rvci9zcmMvbGliL3NlcnZpY2VzL3Bvc2UtZXh0cmFjdG9yLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDekQsT0FBTyxFQUNMLGdCQUFnQixFQUNoQixRQUFRLEVBR1IsZ0JBQWdCLEVBQ2hCLGNBQWMsRUFDZCxtQkFBbUIsRUFDbkIsb0JBQW9CLEdBRXJCLE1BQU0scUJBQXFCLENBQUM7QUFDN0IsT0FBTyxFQUFFLGNBQWMsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7O0FBRS9FOzs7O0dBSUc7QUFFSCxNQUFNLE9BQU8sb0JBQW9CO0lBaUIvQjtRQWhCTywwQkFBcUIsR0FJdkIsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQVVQLHVCQUFrQixHQUFHLEdBQUcsQ0FBQztRQUd4QyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDZCxDQUFDO0lBRU0seUJBQXlCO1FBQzlCLElBQUksQ0FBQyxJQUFJLENBQUMsd0JBQXdCO1lBQUUsT0FBTztRQUMzQyxPQUFPLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN2RCxDQUFDO0lBRU0seUJBQXlCO1FBQzlCLElBQUksQ0FBQyxJQUFJLENBQUMsd0JBQXdCO1lBQUUsT0FBTztRQUMzQyxPQUFPLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN2RCxDQUFDO0lBRU0sS0FBSyxDQUFDLFlBQVksQ0FBQyxZQUE4QjtRQUN0RCxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVE7WUFBRSxPQUFPO1FBRTNCLElBQUksSUFBSSxDQUFDLHdCQUF3QixFQUFFO1lBQ2pDLElB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QUksR0FBRyxJQUFJLEVBQUUsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDO0lBQ2hELENBQUM7O2lIQXZUVSxvQkFBb0I7cUhBQXBCLG9CQUFvQjsyRkFBcEIsb0JBQW9CO2tCQURoQyxVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXZlbnRFbWl0dGVyLCBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBIQU5EX0NPTk5FQ1RJT05TLFxuICBIb2xpc3RpYyxcbiAgTm9ybWFsaXplZExhbmRtYXJrLFxuICBOb3JtYWxpemVkTGFuZG1hcmtMaXN0LFxuICBQT1NFX0NPTk5FQ1RJT05TLFxuICBQT1NFX0xBTkRNQVJLUyxcbiAgUE9TRV9MQU5ETUFSS1NfTEVGVCxcbiAgUE9TRV9MQU5ETUFSS1NfUklHSFQsXG4gIFJlc3VsdHMsXG59IGZyb20gJ0BtZWRpYXBpcGUvaG9saXN0aWMnO1xuaW1wb3J0IHsgZHJhd0Nvbm5lY3RvcnMsIGRyYXdMYW5kbWFya3MsIGxlcnAgfSBmcm9tICdAbWVkaWFwaXBlL2RyYXdpbmdfdXRpbHMnO1xuXG4vKipcbiAqIE1lZGlhUGlwZSDjgpLnlKjjgYTjgabli5XnlLvjgYvjgonjg53jg7zjgrrjgpLmir3lh7rjgZnjgovjgZ/jgoHjga7jgrXjg7zjg5PjgrlcbiAqXG4gKiDigLsg44K344Oz44Kw44Or44OI44Oz44Gq44K144O844OT44K544Gn44Gv44Gq44GE44Gf44KB44CBQ29tcG9uZW50IOOBpyBwcm92aWRlcnMg44Gr5oyH5a6a44GX44Gm5L2/55So44GZ44KL44GT44Go44KS5oOz5a6aXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBQb3NlRXh0cmFjdG9yU2VydmljZSB7XG4gIHB1YmxpYyBvblJlc3VsdHNFdmVudEVtaXR0ZXI6IEV2ZW50RW1pdHRlcjx7XG4gICAgbXBSZXN1bHRzOiBSZXN1bHRzO1xuICAgIHNvdXJjZUltYWdlRGF0YVVybDogc3RyaW5nO1xuICAgIHBvc2VQcmV2aWV3SW1hZ2VEYXRhVXJsOiBzdHJpbmc7XG4gIH0+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIHByaXZhdGUgaG9saXN0aWM/OiBIb2xpc3RpYztcblxuICBwcml2YXRlIHBvc2VQcmV2aWV3Q2FudmFzRWxlbWVudD86IEhUTUxDYW52YXNFbGVtZW50O1xuICBwcml2YXRlIHBvc2VQcmV2aWV3Q2FudmFzQ29udGV4dD86IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRDtcblxuICBwcml2YXRlIGhhbmRQcmV2aWV3Q2FudmFzRWxlbWVudD86IEhUTUxDYW52YXNFbGVtZW50O1xuICBwcml2YXRlIGhhbmRQcmV2aWV3Q2FudmFzQ29udGV4dD86IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRDtcblxuICBwcml2YXRlIHJlYWRvbmx5IElNQUdFX0pQRUdfUVVBTElUWSA9IDAuODtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLmluaXQoKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRQb3NlUHJldmlld01lZGlhU3RyZWFtKCk6IE1lZGlhU3RyZWFtIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoIXRoaXMucG9zZVByZXZpZXdDYW52YXNFbGVtZW50KSByZXR1cm47XG4gICAgcmV0dXJuIHRoaXMucG9zZVByZXZpZXdDYW52YXNFbGVtZW50LmNhcHR1cmVTdHJlYW0oKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRIYW5kUHJldmlld01lZGlhU3RyZWFtKCk6IE1lZGlhU3RyZWFtIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoIXRoaXMuaGFuZFByZXZpZXdDYW52YXNFbGVtZW50KSByZXR1cm47XG4gICAgcmV0dXJuIHRoaXMuaGFuZFByZXZpZXdDYW52YXNFbGVtZW50LmNhcHR1cmVTdHJlYW0oKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBvblZpZGVvRnJhbWUodmlkZW9FbGVtZW50OiBIVE1MVmlkZW9FbGVtZW50KSB7XG4gICAgaWYgKCF0aGlzLmhvbGlzdGljKSByZXR1cm47XG5cbiAgICBpZiAodGhpcy5wb3NlUHJldmlld0NhbnZhc0VsZW1lbnQpIHtcbiAgICAgIHRoaXMucG9zZVByZXZpZXdDYW52YXNFbGVtZW50LndpZHRoID0gdmlkZW9FbGVtZW50LnZpZGVvV2lkdGg7XG4gICAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzRWxlbWVudC5oZWlnaHQgPSB2aWRlb0VsZW1lbnQudmlkZW9IZWlnaHQ7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuaGFuZFByZXZpZXdDYW52YXNFbGVtZW50KSB7XG4gICAgICB0aGlzLmhhbmRQcmV2aWV3Q2FudmFzRWxlbWVudC53aWR0aCA9IHZpZGVvRWxlbWVudC52aWRlb1dpZHRoO1xuICAgICAgdGhpcy5oYW5kUHJldmlld0NhbnZhc0VsZW1lbnQuaGVpZ2h0ID0gdmlkZW9FbGVtZW50LnZpZGVvSGVpZ2h0O1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMuaG9saXN0aWMuc2VuZCh7IGltYWdlOiB2aWRlb0VsZW1lbnQgfSk7XG4gIH1cblxuICBwcml2YXRlIGluaXQoKSB7XG4gICAgdGhpcy5wb3NlUHJldmlld0NhbnZhc0VsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcbiAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzQ29udGV4dCA9XG4gICAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzRWxlbWVudC5nZXRDb250ZXh0KCcyZCcpIHx8IHVuZGVmaW5lZDtcblxuICAgIHRoaXMuaGFuZFByZXZpZXdDYW52YXNFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7XG4gICAgdGhpcy5oYW5kUHJldmlld0NhbnZhc0NvbnRleHQgPVxuICAgICAgdGhpcy5oYW5kUHJldmlld0NhbnZhc0VsZW1lbnQuZ2V0Q29udGV4dCgnMmQnKSB8fCB1bmRlZmluZWQ7XG5cbiAgICB0aGlzLmhvbGlzdGljID0gbmV3IEhvbGlzdGljKHtcbiAgICAgIGxvY2F0ZUZpbGU6IChmaWxlKSA9PiB7XG4gICAgICAgIHJldHVybiBgaHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L25wbS9AbWVkaWFwaXBlL2hvbGlzdGljLyR7ZmlsZX1gO1xuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHRoaXMuaG9saXN0aWMuc2V0T3B0aW9ucyh7XG4gICAgICBzZWxmaWVNb2RlOiBmYWxzZSxcbiAgICAgIG1vZGVsQ29tcGxleGl0eTogMSxcbiAgICAgIHNtb290aExhbmRtYXJrczogdHJ1ZSxcbiAgICAgIGVuYWJsZVNlZ21lbnRhdGlvbjogZmFsc2UsXG4gICAgICBzbW9vdGhTZWdtZW50YXRpb246IHRydWUsXG4gICAgICBtaW5EZXRlY3Rpb25Db25maWRlbmNlOiAwLjYsXG4gICAgICBtaW5UcmFja2luZ0NvbmZpZGVuY2U6IDAuNixcbiAgICB9KTtcblxuICAgIHRoaXMuaG9saXN0aWMub25SZXN1bHRzKChyZXN1bHRzOiBSZXN1bHRzKSA9PiB7XG4gICAgICB0aGlzLm9uUmVzdWx0cyhyZXN1bHRzKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgb25SZXN1bHRzKHJlc3VsdHM6IFJlc3VsdHMpIHtcbiAgICBpZiAoXG4gICAgICAhdGhpcy5wb3NlUHJldmlld0NhbnZhc0VsZW1lbnQgfHxcbiAgICAgICF0aGlzLnBvc2VQcmV2aWV3Q2FudmFzQ29udGV4dCB8fFxuICAgICAgIXRoaXMuaG9saXN0aWNcbiAgICApXG4gICAgICByZXR1cm47XG5cbiAgICAvLyDmj4/nlLvnlKjjgavkuI3lv4XopoHjgarjg6njg7Pjg4njg57jg7zjgq/jgpLpmaTljrtcbiAgICBsZXQgcG9zZUxhbmRtYXJrczogTm9ybWFsaXplZExhbmRtYXJrTGlzdCA9IFtdO1xuICAgIGlmIChyZXN1bHRzLnBvc2VMYW5kbWFya3MpIHtcbiAgICAgIHBvc2VMYW5kbWFya3MgPSBKU09OLnBhcnNlKFxuICAgICAgICBKU09OLnN0cmluZ2lmeShyZXN1bHRzLnBvc2VMYW5kbWFya3MpXG4gICAgICApIGFzIE5vcm1hbGl6ZWRMYW5kbWFya0xpc3Q7XG4gICAgICB0aGlzLnJlbW92ZUVsZW1lbnRzKFxuICAgICAgICBwb3NlTGFuZG1hcmtzLFxuICAgICAgICBbMCwgMSwgMiwgMywgNCwgNSwgNiwgNywgOCwgOSwgMTAsIDE1LCAxNiwgMTcsIDE4LCAxOSwgMjAsIDIxLCAyMl1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8g44Kt44Oj44Oz44OQ44K544KS5aGX44KK44Gk44G244GXXG4gICAgdGhpcy5wb3NlUHJldmlld0NhbnZhc0NvbnRleHQuc2F2ZSgpO1xuICAgIHRoaXMucG9zZVByZXZpZXdDYW52YXNDb250ZXh0LmNsZWFyUmVjdChcbiAgICAgIDAsXG4gICAgICAwLFxuICAgICAgdGhpcy5wb3NlUHJldmlld0NhbnZhc0VsZW1lbnQud2lkdGgsXG4gICAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzRWxlbWVudC5oZWlnaHRcbiAgICApO1xuXG4gICAgLy8g5qSc5Ye644Gr5L2/55So44GX44Gf44OV44Os44O844Og55S75YOP44KS5o+P55S7XG4gICAgdGhpcy5wb3NlUHJldmlld0NhbnZhc0NvbnRleHQuZHJhd0ltYWdlKFxuICAgICAgcmVzdWx0cy5pbWFnZSxcbiAgICAgIDAsXG4gICAgICAwLFxuICAgICAgdGhpcy5wb3NlUHJldmlld0NhbnZhc0VsZW1lbnQud2lkdGgsXG4gICAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzRWxlbWVudC5oZWlnaHRcbiAgICApO1xuXG4gICAgLy8g5qSc5Ye644Gr5L2/55So44GX44Gf44OV44Os44O844Og55S75YOP44KS5L+d5oyBXG4gICAgY29uc3Qgc291cmNlSW1hZ2VEYXRhVXJsID0gdGhpcy5wb3NlUHJldmlld0NhbnZhc0VsZW1lbnQudG9EYXRhVVJMKFxuICAgICAgJ2ltYWdlL2pwZWcnLFxuICAgICAgdGhpcy5JTUFHRV9KUEVHX1FVQUxJVFlcbiAgICApO1xuXG4gICAgLy8g6IKY44Go5omL44KS44Gk44Gq44GQ57ea44KS5o+P55S7XG4gICAgdGhpcy5wb3NlUHJldmlld0NhbnZhc0NvbnRleHQubGluZVdpZHRoID0gNTtcbiAgICBpZiAocG9zZUxhbmRtYXJrcykge1xuICAgICAgaWYgKHJlc3VsdHMucmlnaHRIYW5kTGFuZG1hcmtzKSB7XG4gICAgICAgIHRoaXMucG9zZVByZXZpZXdDYW52YXNDb250ZXh0LnN0cm9rZVN0eWxlID0gJ3doaXRlJztcbiAgICAgICAgdGhpcy5jb25uZWN0KHRoaXMucG9zZVByZXZpZXdDYW52YXNDb250ZXh0LCBbXG4gICAgICAgICAgW1xuICAgICAgICAgICAgcG9zZUxhbmRtYXJrc1tQT1NFX0xBTkRNQVJLUy5SSUdIVF9FTEJPV10sXG4gICAgICAgICAgICByZXN1bHRzLnJpZ2h0SGFuZExhbmRtYXJrc1swXSxcbiAgICAgICAgICBdLFxuICAgICAgICBdKTtcbiAgICAgIH1cbiAgICAgIGlmIChyZXN1bHRzLmxlZnRIYW5kTGFuZG1hcmtzKSB7XG4gICAgICAgIHRoaXMucG9zZVByZXZpZXdDYW52YXNDb250ZXh0LnN0cm9rZVN0eWxlID0gJ3doaXRlJztcbiAgICAgICAgdGhpcy5jb25uZWN0KHRoaXMucG9zZVByZXZpZXdDYW52YXNDb250ZXh0LCBbXG4gICAgICAgICAgW1xuICAgICAgICAgICAgcG9zZUxhbmRtYXJrc1tQT1NFX0xBTkRNQVJLUy5MRUZUX0VMQk9XXSxcbiAgICAgICAgICAgIHJlc3VsdHMubGVmdEhhbmRMYW5kbWFya3NbMF0sXG4gICAgICAgICAgXSxcbiAgICAgICAgXSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8g44Od44O844K644Gu44OX44Os44OT44Ol44O844KS5o+P55S7XG4gICAgaWYgKHBvc2VMYW5kbWFya3MpIHtcbiAgICAgIGRyYXdDb25uZWN0b3JzKFxuICAgICAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzQ29udGV4dCxcbiAgICAgICAgcG9zZUxhbmRtYXJrcyxcbiAgICAgICAgUE9TRV9DT05ORUNUSU9OUyxcbiAgICAgICAgeyBjb2xvcjogJ3doaXRlJyB9XG4gICAgICApO1xuICAgICAgZHJhd0xhbmRtYXJrcyhcbiAgICAgICAgdGhpcy5wb3NlUHJldmlld0NhbnZhc0NvbnRleHQsXG4gICAgICAgIE9iamVjdC52YWx1ZXMoUE9TRV9MQU5ETUFSS1NfTEVGVCkubWFwKChpbmRleCkgPT4gcG9zZUxhbmRtYXJrc1tpbmRleF0pLFxuICAgICAgICB7IHZpc2liaWxpdHlNaW46IDAuNjUsIGNvbG9yOiAnd2hpdGUnLCBmaWxsQ29sb3I6ICdyZ2IoMjU1LDEzOCwwKScgfVxuICAgICAgKTtcbiAgICAgIGRyYXdMYW5kbWFya3MoXG4gICAgICAgIHRoaXMucG9zZVByZXZpZXdDYW52YXNDb250ZXh0LFxuICAgICAgICBPYmplY3QudmFsdWVzKFBPU0VfTEFORE1BUktTX1JJR0hUKS5tYXAoXG4gICAgICAgICAgKGluZGV4KSA9PiBwb3NlTGFuZG1hcmtzW2luZGV4XVxuICAgICAgICApLFxuICAgICAgICB7IHZpc2liaWxpdHlNaW46IDAuNjUsIGNvbG9yOiAnd2hpdGUnLCBmaWxsQ29sb3I6ICdyZ2IoMCwyMTcsMjMxKScgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyDmiYvjga7jg5fjg6zjg5Pjg6Xjg7zjgpLmj4/nlLtcbiAgICBkcmF3Q29ubmVjdG9ycyhcbiAgICAgIHRoaXMucG9zZVByZXZpZXdDYW52YXNDb250ZXh0LFxuICAgICAgcmVzdWx0cy5yaWdodEhhbmRMYW5kbWFya3MsXG4gICAgICBIQU5EX0NPTk5FQ1RJT05TLFxuICAgICAgeyBjb2xvcjogJ3doaXRlJyB9XG4gICAgKTtcbiAgICBkcmF3TGFuZG1hcmtzKHRoaXMucG9zZVByZXZpZXdDYW52YXNDb250ZXh0LCByZXN1bHRzLnJpZ2h0SGFuZExhbmRtYXJrcywge1xuICAgICAgY29sb3I6ICd3aGl0ZScsXG4gICAgICBmaWxsQ29sb3I6ICdyZ2IoMCwyMTcsMjMxKScsXG4gICAgICBsaW5lV2lkdGg6IDIsXG4gICAgICByYWRpdXM6IChkYXRhOiBhbnkpID0+IHtcbiAgICAgICAgcmV0dXJuIGxlcnAoZGF0YS5mcm9tLnosIC0wLjE1LCAwLjEsIDEwLCAxKTtcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgZHJhd0Nvbm5lY3RvcnMoXG4gICAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzQ29udGV4dCxcbiAgICAgIHJlc3VsdHMubGVmdEhhbmRMYW5kbWFya3MsXG4gICAgICBIQU5EX0NPTk5FQ1RJT05TLFxuICAgICAgeyBjb2xvcjogJ3doaXRlJyB9XG4gICAgKTtcbiAgICBkcmF3TGFuZG1hcmtzKHRoaXMucG9zZVByZXZpZXdDYW52YXNDb250ZXh0LCByZXN1bHRzLmxlZnRIYW5kTGFuZG1hcmtzLCB7XG4gICAgICBjb2xvcjogJ3doaXRlJyxcbiAgICAgIGZpbGxDb2xvcjogJ3JnYigyNTUsMTM4LDApJyxcbiAgICAgIGxpbmVXaWR0aDogMixcbiAgICAgIHJhZGl1czogKGRhdGE6IGFueSkgPT4ge1xuICAgICAgICByZXR1cm4gbGVycChkYXRhLmZyb20ueiwgLTAuMTUsIDAuMSwgMTAsIDEpO1xuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIOaJi+OBrumgmOWfn+OBruOBv+OBruODl+ODrOODk+ODpeODvOOCkueUn+aIkFxuICAgIGlmICh0aGlzLmhhbmRQcmV2aWV3Q2FudmFzQ29udGV4dCAmJiB0aGlzLmhhbmRQcmV2aWV3Q2FudmFzRWxlbWVudCkge1xuICAgICAgY29uc3QgSEFORF9QUkVWSUVXX1pPT00gPSAzO1xuICAgICAgY29uc3QgaGFuZFByZXZpZXdCYXNlWSA9IHRoaXMuaGFuZFByZXZpZXdDYW52YXNFbGVtZW50LmhlaWdodCAvIDI7XG5cbiAgICAgIHRoaXMuaGFuZFByZXZpZXdDYW52YXNDb250ZXh0LmNsZWFyUmVjdChcbiAgICAgICAgMCxcbiAgICAgICAgMCxcbiAgICAgICAgdGhpcy5oYW5kUHJldmlld0NhbnZhc0VsZW1lbnQud2lkdGgsXG4gICAgICAgIHRoaXMuaGFuZFByZXZpZXdDYW52YXNFbGVtZW50LmhlaWdodFxuICAgICAgKTtcblxuICAgICAgaWYgKHJlc3VsdHMucmlnaHRIYW5kTGFuZG1hcmtzKSB7XG4gICAgICAgIGNvbnN0IHJlY3QgPSB0aGlzLmdldFJlY3RCeUxhbmRtYXJrcyhcbiAgICAgICAgICByZXN1bHRzLnJpZ2h0SGFuZExhbmRtYXJrcyxcbiAgICAgICAgICByZXN1bHRzLmltYWdlLndpZHRoLFxuICAgICAgICAgIHJlc3VsdHMuaW1hZ2UuaGVpZ2h0XG4gICAgICAgICk7XG5cbiAgICAgICAgbGV0IGhhbmRQcmV2aWV3WCA9IDA7XG4gICAgICAgIGxldCBoYW5kUHJldmlld1kgPSBoYW5kUHJldmlld0Jhc2VZIC0gKHJlY3RbM10gKiBIQU5EX1BSRVZJRVdfWk9PTSkgLyAyO1xuXG4gICAgICAgIHRoaXMuaGFuZFByZXZpZXdDYW52YXNDb250ZXh0LmRyYXdJbWFnZShcbiAgICAgICAgICB0aGlzLnBvc2VQcmV2aWV3Q2FudmFzRWxlbWVudCxcbiAgICAgICAgICByZWN0WzBdIC0gMTAsXG4gICAgICAgICAgcmVjdFsxXSAtIDEwLFxuICAgICAgICAgIHJlY3RbMl0gKyAxMCxcbiAgICAgICAgICByZWN0WzNdICsgMTAsXG4gICAgICAgICAgaGFuZFByZXZpZXdYLFxuICAgICAgICAgIGhhbmRQcmV2aWV3WSxcbiAgICAgICAgICByZWN0WzJdICogSEFORF9QUkVWSUVXX1pPT00sXG4gICAgICAgICAgcmVjdFszXSAqIEhBTkRfUFJFVklFV19aT09NXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGlmIChyZXN1bHRzLmxlZnRIYW5kTGFuZG1hcmtzKSB7XG4gICAgICAgIGNvbnN0IHJlY3QgPSB0aGlzLmdldFJlY3RCeUxhbmRtYXJrcyhcbiAgICAgICAgICByZXN1bHRzLmxlZnRIYW5kTGFuZG1hcmtzLFxuICAgICAgICAgIHJlc3VsdHMuaW1hZ2Uud2lkdGgsXG4gICAgICAgICAgcmVzdWx0cy5pbWFnZS5oZWlnaHRcbiAgICAgICAgKTtcblxuICAgICAgICBsZXQgaGFuZFByZXZpZXdYID1cbiAgICAgICAgICB0aGlzLmhhbmRQcmV2aWV3Q2FudmFzRWxlbWVudC53aWR0aCAtIHJlY3RbMl0gKiBIQU5EX1BSRVZJRVdfWk9PTTtcbiAgICAgICAgbGV0IGhhbmRQcmV2aWV3WSA9IGhhbmRQcmV2aWV3QmFzZVkgLSAocmVjdFszXSAqIEhBTkRfUFJFVklFV19aT09NKSAvIDI7XG5cbiAgICAgICAgdGhpcy5oYW5kUHJldmlld0NhbnZhc0NvbnRleHQuZHJhd0ltYWdlKFxuICAgICAgICAgIHRoaXMucG9zZVByZXZpZXdDYW52YXNFbGVtZW50LFxuICAgICAgICAgIHJlY3RbMF0gLSAxMCxcbiAgICAgICAgICByZWN0WzFdIC0gMTAsXG4gICAgICAgICAgcmVjdFsyXSArIDEwLFxuICAgICAgICAgIHJlY3RbM10gKyAxMCxcbiAgICAgICAgICBoYW5kUHJldmlld1gsXG4gICAgICAgICAgaGFuZFByZXZpZXdZLFxuICAgICAgICAgIHJlY3RbMl0gKiBIQU5EX1BSRVZJRVdfWk9PTSxcbiAgICAgICAgICByZWN0WzNdICogSEFORF9QUkVWSUVXX1pPT01cbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyDjgqTjg5njg7Pjg4jjgpLpgIHlh7pcbiAgICB0aGlzLm9uUmVzdWx0c0V2ZW50RW1pdHRlci5lbWl0KHtcbiAgICAgIG1wUmVzdWx0czogcmVzdWx0cyxcbiAgICAgIHNvdXJjZUltYWdlRGF0YVVybDogc291cmNlSW1hZ2VEYXRhVXJsLFxuICAgICAgcG9zZVByZXZpZXdJbWFnZURhdGFVcmw6IHRoaXMucG9zZVByZXZpZXdDYW52YXNFbGVtZW50LnRvRGF0YVVSTChcbiAgICAgICAgJ2ltYWdlL2pwZWcnLFxuICAgICAgICB0aGlzLklNQUdFX0pQRUdfUVVBTElUWVxuICAgICAgKSxcbiAgICB9KTtcblxuICAgIC8vIOWujOS6hlxuICAgIHRoaXMucG9zZVByZXZpZXdDYW52YXNDb250ZXh0LnJlc3RvcmUoKTtcbiAgfVxuXG4gIHByaXZhdGUgY29ubmVjdChcbiAgICBjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCxcbiAgICBjb25uZWN0b3JzOiBBcnJheTxbTm9ybWFsaXplZExhbmRtYXJrLCBOb3JtYWxpemVkTGFuZG1hcmtdPlxuICApIHtcbiAgICBjb25zdCBjYW52YXMgPSBjdHguY2FudmFzO1xuICAgIGZvciAoY29uc3QgY29ubmVjdG9yIG9mIGNvbm5lY3RvcnMpIHtcbiAgICAgIGNvbnN0IGZyb20gPSBjb25uZWN0b3JbMF07XG4gICAgICBjb25zdCB0byA9IGNvbm5lY3RvclsxXTtcbiAgICAgIGlmIChmcm9tICYmIHRvKSB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICBmcm9tLnZpc2liaWxpdHkgJiZcbiAgICAgICAgICB0by52aXNpYmlsaXR5ICYmXG4gICAgICAgICAgKGZyb20udmlzaWJpbGl0eSA8IDAuMSB8fCB0by52aXNpYmlsaXR5IDwgMC4xKVxuICAgICAgICApIHtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICBjdHguYmVnaW5QYXRoKCk7XG4gICAgICAgIGN0eC5tb3ZlVG8oZnJvbS54ICogY2FudmFzLndpZHRoLCBmcm9tLnkgKiBjYW52YXMuaGVpZ2h0KTtcbiAgICAgICAgY3R4LmxpbmVUbyh0by54ICogY2FudmFzLndpZHRoLCB0by55ICogY2FudmFzLmhlaWdodCk7XG4gICAgICAgIGN0eC5zdHJva2UoKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZUVsZW1lbnRzKFxuICAgIGxhbmRtYXJrczogTm9ybWFsaXplZExhbmRtYXJrTGlzdCxcbiAgICBlbGVtZW50czogbnVtYmVyW11cbiAgKSB7XG4gICAgZm9yIChjb25zdCBlbGVtZW50IG9mIGVsZW1lbnRzKSB7XG4gICAgICBkZWxldGUgbGFuZG1hcmtzW2VsZW1lbnRdO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0UmVjdEJ5TGFuZG1hcmtzKGxhbmRtYXJrczogYW55W10sIHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyKSB7XG4gICAgY29uc3QgbGVmdEhhbmRMYW5kbWFya3NYID0gbGFuZG1hcmtzLm1hcCgobGFuZG1hcmspID0+IGxhbmRtYXJrLnggKiB3aWR0aCk7XG4gICAgY29uc3QgbGVmdEhhbmRMYW5kbWFya3NZID0gbGFuZG1hcmtzLm1hcCgobGFuZG1hcmspID0+IGxhbmRtYXJrLnkgKiBoZWlnaHQpO1xuICAgIGNvbnN0IG1pblggPSBNYXRoLm1pbiguLi5sZWZ0SGFuZExhbmRtYXJrc1gpO1xuICAgIGNvbnN0IG1heFggPSBNYXRoLm1heCguLi5sZWZ0SGFuZExhbmRtYXJrc1gpO1xuICAgIGNvbnN0IG1pblkgPSBNYXRoLm1pbiguLi5sZWZ0SGFuZExhbmRtYXJrc1kpO1xuICAgIGNvbnN0IG1heFkgPSBNYXRoLm1heCguLi5sZWZ0SGFuZExhbmRtYXJrc1kpO1xuICAgIHJldHVybiBbbWluWCwgbWluWSwgbWF4WCAtIG1pblgsIG1heFkgLSBtaW5ZXTtcbiAgfVxufVxuIl19